name: PR Maintenance

# run on pull_request_target because we need write access to the GItHub API
# don't run any code from PR here!
on:
  pull_request_target:
  workflow_dispatch:
  push:

jobs:
# For each branch (i.e. PR) we're only interested in the latest commit to be tested
# this job cancels any previous workflow runs still in progress on the same branch
# freeing up spots in the queue for the most recent commits
# and saving some trees along the way

  cancel:
    name: 'Cancel Outdated Workflow Runs'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: styfle/cancel-workflow-action@0.9.1
        with:
          workflow_id: 'integration-tests.yml,k8s-testing.yml,unit-tests.yml'
          access_token: ${{ github.token }}


  detect-merge-conflicts:
    name: "Detect Merge Conflicts"
    runs-on: ubuntu-latest
    steps:
      - name: check if prs are conflicted
        uses: eps1lon/actions-label-merge-conflict@releases/2.x
        with:
          dirtyLabel: "conflicts-detected"
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          commentOnDirty: "This pull request has conflicts, please resolve those before we can evaluate the pull request."
          commentOnClean: "Conflicts have been resolved. A maintainer will review the pull request shortly."

  labeler:
    name: "Autolabeler"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/labeler@v3
      with:
        repo-token: "${{ secrets.GITHUB_TOKEN }}"
        sync-labels: true

name: DAST Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  dast:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Запуск вашего приложения (если необходимо)
      - name: Start application
        run: |
          # Здесь запустите ваше приложение локально
          # Например, для Flask-приложения:
          nohup python app.py > app.log 2>&1 &
          echo "Waiting for the application to start..."
          sleep 20  # Даем приложению время на запуск

      # Проверка доступности целевого URL
      - name: Check if target URL is reachable
        run: |
          if ! curl -s --head --fail ${{ secrets.DAST_TARGET_URL }} > /dev/null; then
            echo "Target URL is not reachable! Skipping DAST scan."
            exit 0  # Продолжаем выполнение пайплайна без ошибки
          fi

      # Запуск OWASP ZAP с дополнительной обработкой ошибок
      - name: Run OWASP ZAP
        id: zap-scan
        uses: zaproxy/action-full-scan@v0.8.0
        with:
          target: ${{ secrets.DAST_TARGET_URL }}  # URL вашего приложения
          spider: true  # Включить паучий поиск
          active-scan: true  # Включить активное сканирование
          generate-html-report: true  # Генерировать HTML-отчет
          exit-code: 0  # Не завершать пайплайн с ошибкой, даже если найдены уязвимости
        continue-on-error: true  # Продолжать выполнение пайплайна, даже если шаг завершился с ошибкой

      # Проверка наличия отчета OWASP ZAP
      - name: Check ZAP Report
        run: |
          if [ ! -f "./zap/wrk/report.html" ]; then
            echo "OWASP ZAP report not found! Possible reasons:"
            echo "- The scan failed to complete successfully."
            echo "- The report generation was unsuccessful."
            echo "Skipping further steps due to missing report."
            exit 0  # Продолжаем выполнение пайплайна без ошибки
          fi

      # Сохранение отчетов как артефактов
      - name: Upload DAST report
        if: exists('./zap/wrk/report.html')  # Выполняем только если отчет существует
        uses: actions/upload-artifact@v4
        with:
          name: dast-report
          path: ./zap/wrk/report.html  # Путь к сгенерированному отчету

      # Опционально: Отправка результатов в систему управления уязвимостями
      - name: Send results to vulnerability management system
        if: exists('./zap/wrk/report.json')  # Выполняем только если отчет существует
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d @./zap/wrk/report.json \
            ${{ secrets.VULN_MANAGEMENT_API }}
        if: always()  # Выполнить этот шаг всегда, независимо от успеха предыдущих шагов

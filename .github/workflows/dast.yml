name: DAST

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch: {}

permissions:
  contents: read

env:
  TARGET_URL: ${{ secrets.TARGET_URL }}
  DD_URL: ${{ secrets.DD_URL }}
  DD_API_KEY: ${{ secrets.DD_API_KEY }}
  DD_ENGAGEMENT_ID: ${{ secrets.DD_ENGAGEMENT_ID }}

jobs:
  zap-baseline:
    name: ZAP Baseline (site)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4


      - name: Run ZAP Baseline
        run: |
          docker run --rm -v $(pwd):/zap/wrk/:rw \
            -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t ${{ env.TARGET_URL }} \
            -j zap_report.json \
            -r zap_report.html


      - name: Upload ZAP report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap_baseline_report
          path: |
            zap_report.json
            zap_report.html
          if-no-files-found: ignore


      - name: Upload to DefectDojo (reimport â†’ import)
        if: ${{ env.DD_URL != '' && env.DD_API_KEY != '' && env.DD_ENGAGEMENT_ID != '' }}
        run: |
          set -e
          test -f zap_report.json || { echo "ZAP JSON report not found, skip Dojo upload"; exit 0; }

          curl -sS -X POST "$DD_URL/api/v2/reimport-scan/" \
            -H "Authorization: Token $DD_API_KEY" \
            -F "engagement=$DD_ENGAGEMENT_ID" \
            -F "scan_type=ZAP Scan" \
            -F "file=@zap_report.json" \
            -F "test_title=ZAP Baseline" \
            -F "build_id=$GITHUB_RUN_NUMBER" \
            -F "commit_hash=$GITHUB_SHA" \
            -F "branch_tag=$GITHUB_REF_NAME" \
            -F "close_old_findings=True" \
          || curl -sS -X POST "$DD_URL/api/v2/import-scan/" \
            -H "Authorization: Token $DD_API_KEY" \
            -F "engagement=$DD_ENGAGEMENT_ID" \
            -F "scan_type=ZAP Scan" \
            -F "file=@zap_report.json" \
            -F "test_title=ZAP Baseline" \
            -F "build_id=$GITHUB_RUN_NUMBER" \
            -F "commit_hash=$GITHUB_SHA" \
            -F "branch_tag=$GITHUB_REF_NAME" \
            -F "active=True" -F "verified=False"

from django.db import transaction
from rest_framework import serializers
from dojo.models import Engagement, Product, Dojo_User
from dojo.api_v2.pentesting.models import InputSecret, InputFile, Input, InputEngagement

# ...existing code...
class InputSecretSerializer(serializers.ModelSerializer):
    class Meta:
        model = InputSecret
        fields = [
            "input",
            "key",
            "secret",
            "status"
        ]

class InputFileSerializer(serializers.ModelSerializer):
    class Meta:
        model = InputFile
        fields = [
            "input",
            "file",
            "file_name"
        ]
    
    def update(self, instance, validated_data):
        request = validated_data.pop("request", None)
        instance.file = request.data.get('file', instance.file) if request else instance.file 
        instance.file_name = validated_data.get('file_name', instance.file_name)
        instance.save()
        return instance

class ScopeFileSerializers(serializers.Serializer):
    CHOICES = (
        ("secret", "Secret"),
        ("file", "File"),
    )
    engagement = serializers.PrimaryKeyRelatedField(queryset=Engagement.objects.all(), required=False, allow_null=True)
    product = serializers.PrimaryKeyRelatedField(queryset=Product.objects.all(), required=False, allow_null=True)
    description = serializers.CharField()
    url = serializers.CharField(max_length=255, required=False, allow_null=True, allow_blank=True)
    file = serializers.FileField(required=False, allow_null=True)
    file_name = serializers.CharField(required=False, allow_null=True)
    type = serializers.ChoiceField(choices=CHOICES, required=True)
    
    def create(self, validated_data):
        request = validated_data.pop("request", None)
        owner = request.user if request else None 

        with transaction.atomic():
            input_instance = Input.objects.create(
                description=validated_data['description'],
                owner=owner,
                type=validated_data['type']
            )
            input_engagement_instance = InputEngagement.objects.create(
                engagement=validated_data.get('engagement', None),
                product=validated_data.get('product', None),
                input=input_instance
            )
            if file := request.data.get('file'):
                InputFile.objects.create(
                    input=input_instance,
                    file=file,
                    file_name=validated_data.get('file_name', file.name)
                )
        return input_engagement_instance


class ScopeSecretSerializers(serializers.Serializer):
    CHOICES = (
        ("secret", "Secret"),
        ("file", "File"),
    )
    engagement = serializers.PrimaryKeyRelatedField(queryset=Engagement.objects.all(), required=False, allow_null=True)
    product = serializers.PrimaryKeyRelatedField(queryset=Product.objects.all(), required=False, allow_null=True)
    description = serializers.CharField(required=False)
    type = serializers.ChoiceField(choices=CHOICES, required=True)
    owner = serializers.PrimaryKeyRelatedField(queryset=Dojo_User.objects.all(), required=False)
    url = serializers.CharField(required=False, allow_null=True, allow_blank=True)
    key = serializers.CharField(required=True)
    secret = serializers.CharField(required=True)
    status = serializers.BooleanField(default=True, required=False)
    
    def create(self, validated_data):
        owner = validated_data.pop("owner", None)
        with transaction.atomic():
            input_instance = Input.objects.create(
                description=validated_data['description'],
                owner=owner,
                url=validated_data.get("url", None),
                type=validated_data['type']
            )
            input_engagement_instance = InputEngagement.objects.create(
                engagement=validated_data.get('engagement', None),
                product=validated_data.get('product', None),
                input=input_instance
            )
            if key := validated_data.get('key'):
                InputSecret.objects.create(
                    input=input_instance,
                    key=key,
                    secret=validated_data['secret'],
                    status=validated_data['status']
                )
        return input_engagement_instance 

class InputBasicSerializer(serializers.ModelSerializer):
    class Meta:
        model = Input
        fields = ["id", "description", "type", "owner", "url", "created", "updated"]

class InputEngagementSerializer(serializers.ModelSerializer):
    input = serializers.SerializerMethodField()
    class Meta:
        model = InputEngagement
        fields = ["engagement", "product", "input"]
    
    def get_input(self, obj):
        input_obj = getattr(obj, "input", None)
        if not input_obj:
            return None

        try:
            serializer = None
            if input_obj.type == "secret":
                secret = InputSecret.objects.get(input=input_obj)
                serializer =  InputSecretSerializer(secret).data
            else: 
                f = InputFile.objects.get(input=input_obj)
                serializer =  InputFileSerializer(f).data
            return serializer
        except InputSecret.DoesNotExist:
            return InputBasicSerializer(input_obj).data

class InputSerializer(serializers.Serializer):
    id = serializers.IntegerField(read_only=True)
    description = serializers.CharField(max_length=255, required=False)
    type = serializers.CharField(required=True)
    owner = serializers.PrimaryKeyRelatedField(queryset=Dojo_User.objects.all(), required=False)
    url = serializers.CharField(max_length=255, required=False, allow_null=True, allow_blank=True)
    input_engagement = InputEngagementSerializer(source="inputengagement_set", many=True)
    created = serializers.DateTimeField(read_only=True)
    updated = serializers.DateTimeField(read_only=True)
    
    class Meta:
        model = Input 
        fields = [
            "id",
            "description",
            "type",
            "owner",
            "input",
            "url",
            "created",
            "updated"]

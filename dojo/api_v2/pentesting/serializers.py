from django.db import transaction
from rest_framework import serializers
from dojo.models import Engagement
from dojo.api_v2.pentesting.models import InputSecret, InputFile, Scope

class InputSecretSerializer(serializers.ModelSerializer):
    class Meta:
        model = InputSecret
        fields = [
            "key",
            "description"
            "secret"
        ]

class InputFileSerializer(serializers.ModelSerializer):
    class Meta:
        model = InputFile
        fields = [
            "file_name",
            "description",
            "file_data",
        ]
class ScopeSerializers(serializers.ModelSerializer):
    engagement = serializers.PrimaryKeyRelatedField(queryset=Engagement.objects.all())
    input_secret = InputSecretSerializer(read_only=True)
    input_file = InputFileSerializer(read_only=True) 
    class Meta:
        model = Scope
        fields = [
            "engagement",
            "input_secret",
            "input_file",
        ]
    
    def create(self, validated_data):
        secret_data = validated_data.pop("input_secret", None)
        file_data = validated_data.pop("input_file", None)
        user = self.context.get("request").user.username if self.context.get("request") else None

        with transaction.atomic():
            secret = InputSecret.objects.create(**secret_data) if secret_data else None
            file = InputFile.objects.create(**file_data) if file_data else None
            scope = Scope.objects.create(
                engagement=validated_data["engagement"],
                input_secret=secret,
                input_file=file,
            )
        return scope
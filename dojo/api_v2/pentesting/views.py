import logging
from rest_framework import status
from rest_framework.permissions import IsAuthenticated
from django.db import transaction, IntegrityError
from dojo.api_v2.pentesting.models import InputSecret, InputFile, Scope
from dojo.api_v2.pentesting.serializers import ScopeSerializers
from dojo.api_v2.views import DojoModelViewSet
from dojo.api_v2.utils import http_response
from dojo.authorization.roles_permissions import Permissions
from django_filters.rest_framework import DjangoFilterBackend
from dojo.api_v2.api_error import ApiError
from drf_spectacular.utils import (
    OpenApiParameter,
    OpenApiResponse,
    extend_schema,
    extend_schema_view,
    OpenApiTypes,
)
from dojo.api_v2 import (
    permissions,
    prefetch,
    serializers,
)
logger = logging.getLogger(__name__)


class ScopeViewSet(prefetch.PrefetchListMixin,
                             prefetch.PrefetchRetrieveMixin,
                             DojoModelViewSet):
    queryset = Scope.objects.all() 
    permission_classes = (IsAuthenticated,
                          permissions.UserHasEngagementPermission,)
    serializer_class = ScopeSerializers 
    filter_backends = (DjangoFilterBackend,)
    filterset_fields = [
        "id",
        "engagement",
    ] 
    @extend_schema(
        request=ScopeSerializers,
        responses={status.HTTP_201_CREATED: ScopeSerializers},
    )
    def create(self, request, *args, **kwargs):
        try:
            serializer = ScopeSerializers(data=request.data)
            serializer.is_valid(raise_exception=True)
            
            serializer.save()
            return http_response(
                serializer.data,
                status=status.HTTP_201_CREATED,
            )
        except IntegrityError as e:
            logger.error(f"IntegrityError while creating Scope: {e}")
            return http_response(
                ApiError(
                    status.HTTP_400_BAD_REQUEST,
                    "integrity_error",
                    "A database integrity error occurred while creating the Scope.",
                ),
                status=status.HTTP_400_BAD_REQUEST,
            )

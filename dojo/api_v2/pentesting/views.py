import logging
import os
import mimetypes
from rest_framework.decorators import action
from rest_framework import status
from rest_framework.permissions import IsAuthenticated
from django.db import transaction, IntegrityError
from dojo.api_v2.pentesting.filter import InputFilter
from dojo.api_v2.pentesting.models import InputSecret, InputFile, Input, InputEngagement
from dojo.api_v2.pentesting.serializers import *
from dojo.api_v2.views import DojoModelViewSet
from dojo.api_v2.utils import http_response
from dojo.authorization.roles_permissions import Permissions
from django.shortcuts import get_object_or_404
from django_filters.rest_framework import DjangoFilterBackend
from django.http import FileResponse
from dojo.api_v2.api_error import ApiError
from drf_spectacular.utils import (
    OpenApiParameter,
    OpenApiResponse,
    extend_schema,
    extend_schema_view,
    OpenApiTypes,
)
from dojo.api_v2 import (
    permissions,
    prefetch,
)
from rest_framework.parsers import MultiPartParser, FormParser, JSONParser
import json

logger = logging.getLogger(__name__)


class ScopeViewSet(prefetch.PrefetchListMixin,
                             prefetch.PrefetchRetrieveMixin,
                             DojoModelViewSet):
    queryset = Input.objects.all() 
    permission_classes = (IsAuthenticated,
                          permissions.UserHasEngagementPermission,)
    serializer_class = InputSerializer
    filter_backends = (DjangoFilterBackend,)
    filterset_class = InputFilter

    def list(self, request, *args, **kwargs):
        return http_response.ok(
            message="Scope list retrieved successfully.",
            data=self.get_serializer(self.filter_queryset(self.get_queryset()), many=True).data
        )

    @extend_schema(
        parameters=[
            OpenApiParameter(
                name="engagement",
                type=OpenApiTypes.INT,
                description="Engagement ID",
                required=True,
            ),
            OpenApiParameter(
                name="product",
                type=OpenApiTypes.INT,
                description="Product ID",
                required=True,
            ),
            OpenApiParameter(
                name="description",
                type=OpenApiTypes.STR,
                description="Description",
                required=True,
            ),
            OpenApiParameter(
                name="type",
                type=OpenApiTypes.STR,
                description="Type input (secret/file)",
                required=True,
                enum=["secret", "file"],
            ),
            OpenApiParameter(
                name="file",
                type=OpenApiTypes.BINARY,
                description="File to upload",
                required=True,
            ),
            OpenApiParameter(
                name="file_name",
                type=OpenApiTypes.STR,
                description="File name",
                required=True,
            ),
        ],
        responses={status.HTTP_201_CREATED: ScopeFileSerializers},
    )
    @action(detail=False, methods=["post"])
    def create_scope_file(self, request, *args, **kwargs):
        try:
            serializer = ScopeFileSerializers(data=request.query_params)
            serializer.is_valid(raise_exception=True)
            instance = serializer.save(request=request)
            return http_response.ok(message="Input Engagement created successfully.", data=InputEngagementSerializer(instance).data)
        except IntegrityError as e:
            logger.error(f"IntegrityError while creating Input Engagement: {e}")
            return http_response.error(
                message="Integrity error occurred while creating Input Engagement.", data=serializer.errors)
    
    @extend_schema(
        parameters=[
            OpenApiParameter(
                name="engagement",
                type=OpenApiTypes.INT,
                description="Engagement ID",
                required=True,
            ),
            OpenApiParameter(
                name="product",
                type=OpenApiTypes.INT,
                description="Product ID",
                required=True,
            ),
            OpenApiParameter(
                name="type",
                type=OpenApiTypes.STR,
                description="Type input (secret/file)",
                required=True,
                enum=["secret", "file"],
            ),
            OpenApiParameter(
                name="description",
                type=OpenApiTypes.STR,
                description="Description",
                required=True,
            ),
            OpenApiParameter(
                name="key",
                type=OpenApiTypes.STR,
                description="key secret",
                required=True,
            ),
            OpenApiParameter(
                name="secret",
                type=OpenApiTypes.STR,
                description="secret value",
                required=True,
            ),
            OpenApiParameter(
                name="status",
                type=OpenApiTypes.STR,
                description="status value",
                required=False,
            ),
        ],
        responses={status.HTTP_201_CREATED: ScopeSecretSerializers},
    )
    @action(detail=False, methods=["post"])
    def create_scope_secret(self, request, *args, **kwargs):
        try:
            serializer = ScopeSecretSerializers(data=request.query_params)
            serializer.is_valid(raise_exception=True)
            instance = serializer.save(owner=request.user)
            return http_response.ok(message="Input Engagement created successfully.", data=InputEngagementSerializer(instance).data)
        except IntegrityError as e:
            logger.error(f"IntegrityError while creating Input Engagement: {e}")
            return http_response.error(
                message="Integrity error occurred while creating Input Engagement.", data=serializer.errors)

    @extend_schema(
        parameters=[
            OpenApiParameter(
                name="input",
                type=OpenApiTypes.INT,
                description="Input ID",
                required=True,
            ),
        ],
    )
    @action(detail=False, methods=["get"], url_path="download_file")
    def download_file(self, request, *args, **kwargs):
        """
        GET /.../download_file/?input=<input_id>
        Returns the file attached to the given Input as a downloadable response.
        """
        input_id = request.query_params.get("input") or request.query_params.get("input_id")
        if not input_id:
            return http_response.error(message="Missing 'input' query parameter.", data=None)

        input_file = get_object_or_404(InputFile, input__id=input_id)

        file_field = input_file.file
        if not file_field:
            raise ApiError.not_found(contex="File not fonud")

        try:
            file_handle = file_field.open("rb")
        except Exception as e:
            raise ApiError.internal_server_error(contex="Unable to open file: " + str(e))

        filename = os.path.basename(file_field.name)
        content_type, _ = mimetypes.guess_type(filename)
        response = FileResponse(
            file_handle,
            as_attachment=True,
            filename=filename,
            content_type=content_type or "application/octet-stream"
            )
        return response

@extend_schema(tags=["pentesting"])
class InputSecretViewSet(prefetch.PrefetchListMixin,
                             prefetch.PrefetchRetrieveMixin,
                             DojoModelViewSet):
    queryset = InputSecret.objects.all() 
    permission_classes = (IsAuthenticated,
                          permissions.UserHasEngagementPermission,)
    serializer_class = InputSecretSerializer 
    filter_backends = (DjangoFilterBackend,)

@extend_schema(tags=["pentesting"])
class InputFileViewSet(prefetch.PrefetchListMixin,
                             prefetch.PrefetchRetrieveMixin,
                             DojoModelViewSet):
    queryset = InputFile.objects.all() 
    permission_classes = (IsAuthenticated,
                          permissions.UserHasEngagementPermission,)
    serializer_class = InputFileSerializer 
    filter_backends = (DjangoFilterBackend,)
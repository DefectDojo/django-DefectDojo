import json
import re

from dojo.models import Finding


class GithubVulnerabilityParser(object):
    def get_scan_types(self):
        return ["Github Vulnerability Scan"]

    def get_label_for_scan_types(self, scan_type):
        return scan_type  # no custom label for now

    def get_description_for_scan_types(self, scan_type):
        return "Import vulnerabilities from Github API."

    def get_findings(self, filename, test):
        data = json.load(filename)
        if "data" not in data:
            raise ValueError("Invalid report file, no 'data' node found")

        vulnerabilityAlerts = self._search_vulnerability_alerts(data["data"])
        if not vulnerabilityAlerts:
            raise ValueError("Invalid report, no 'vulnerabilityAlerts' node found")

        dupes = dict()
        for alert in vulnerabilityAlerts["nodes"]:
            finding = Finding(
                title=alert["securityVulnerability"]["advisory"]["summary"],
                test=test,
                description=alert["securityVulnerability"]["advisory"]["description"],
                severity=self._convert_security(alert["securityVulnerability"].get("severity", "MODERATE")),
                static_finding=True,
                dynamic_finding=False,
                unique_id_from_tool=alert["id"],
            )

            if "vulnerableManifestPath" in alert:
                finding.file_path = alert["vulnerableManifestPath"]

            # if the package is present
            if "package" in alert["securityVulnerability"]:
                finding.component_name = alert["securityVulnerability"]["package"].get("name")

            if "references" in alert["securityVulnerability"]["advisory"]:
                finding.references = ""
                for ref in alert["securityVulnerability"]["advisory"]["references"]:
                    finding.references += ref["url"] + "\r\n"
                    # check if there is CVE
                    if self._get_cve(ref["url"]):
                        finding.cve = self._get_cve(ref["url"])

            if "cvss" in alert["securityVulnerability"]["advisory"]:
                if "score" in alert["securityVulnerability"]["advisory"]["cvss"]:
                    finding.cvssv3_score = alert["securityVulnerability"]["advisory"]["cvss"]["score"]
                if "vectorString" in alert["securityVulnerability"]["advisory"]["cvss"]:
                    finding.cvssv3 = alert["securityVulnerability"]["advisory"]["cvss"]["vectorString"]

            dupe_key = finding.unique_id_from_tool
            if dupe_key in dupes:
                find = dupes[dupe_key]
                find.nb_occurences += 1
            else:
                dupes[dupe_key] = finding

        return list(dupes.values())

    def _search_vulnerability_alerts(self, data):
        if isinstance(data, list):
            for item in data:
                result = self._search_vulnerability_alerts(item)
                if result:
                    return result
        elif isinstance(data, dict):
            for key in data:
                if key == "vulnerabilityAlerts":
                    return data[key]
                result = self._search_vulnerability_alerts(data[key])
                if result:
                    return result
        return None

    def _convert_security(self, val):
        if val.lower() == "moderate":
            return "Medium"
        else:
            return val.title()

    def _get_cve(self, val):
        cve_search = re.search(r"CVE-\d{4}-\d{4,9}", val, re.IGNORECASE)
        return cve_search.group(0) if cve_search else None

{% extends "base.html" %}
{% block content %}
    {{ block.super }}
    {% load event_tags %}
    {% load display_tags %}
    {% load humanize %}
    {% load get_endpoint_status %}
    {% load get_note_status %}
    {% load get_notetype_availability %}

    <button onclick="asciidocDownload()" class="btn btn-primary" type="button">
        Download Report
    </button>

    {% if product_type %}
        <h2>= {{ product_type }} =</h2>
    {% elif product %}
        <h2>= {{ product }} {% if endpoints %} - Endpoints {% endif %}=</h2>
    {% elif engagement %}
        <h2>= {{ engagement.product.name }}: {{ engagement }} =</h2>
    {% elif test %}
        <h2>= {{ test.engagement.product.name }}: {{ test.engagement }}, {{ test }} =</h2>
    {% elif endpoint %}
        <h2>= Endpoint Report =</h2>
        {% if host_view %}
            <h2>= {{ endpoint.host }} =</h2>
        {% else %}
            <h2>= {{ endpoint }} =</h2>
        {% endif %}
    {% endif %}
    Generated By {{ user.get_full_name }} &lt;{{ request.user.email }}&gt;<br>
    Generated On {% now "SHORT_DATE_FORMAT" %}<br>
    {% if include_table_of_contents%}
        <div class="row">
            <div class="col-lg-12" id="toc">
                <h3 id="table_of_contents">Table of Contents for {{ product.name }}</h3>
            </div>
        </div>

        <div id="contents">
    {% endif %}
    {% if include_executive_summary and not endpoint %}
        <br>
        <h3>== Executive Summary ==</h3>
        <p>
            {% if product_type %}
                {% for prod in product_type.prod_type.all %}
                    <h4>=== {{ prod.name }} ===</h4><br>

                    {% if prod.engagement_set.all %}
                        {% for eng in prod.engagement_set.all %}
                            {% if eng.name  and eng.name|length > 0 %}
                                The {{ eng.name }}
                            {% else %}
                                An
                            {% endif %}
                            engagement ran from {{ eng.target_start|date:"SHORT_DATE_FORMAT" }}
                            {% if eng.target_end %}
                                to {{ eng.target_end|date:"SHORT_DATE_FORMAT" }}.
                            {% else %}
                                and is ongoing.
                            {% endif %}
                            {% if eng.test_set %}
                                <br><br>The engagement also included the following tests which may be reported here:<br>
                                <br>
                                {% for t in eng.test_set.all %}
                                    * {{ t }}
                                    ({{ t.environment.name|default:"unknown" }}):
                                    {{ t.target_start|date:"SHORT_DATE_FORMAT" }}<br>
                                {% endfor %}
                            {% endif %}
                            {% if eng.test_strategy %}
                                <br>The test strategy for this engagement can be viewed at
                                <a href="{{ eng.test_strategy }}">{{ eng.test_strategy }}</a><br><br>
                            {% else %}
                                <br>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        No engagements found for {{ prod.name }} <br><br>
                    {% endif %}
                {% endfor %}
                A total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying severity are
                represented in this report.
            {% endif %}
        {% if product %}
            {% if product.engagement_set.all %}
                {% for eng in product.engagement_set.all %}
                    <br>
                    {% if eng.name  and eng.name|length > 0 %}
                        The {{ eng.name }}
                    {% else %}
                        An
                    {% endif %}
                    engagement ran from {{ eng.target_start|date:"SHORT_DATE_FORMAT" }}
                    {% if eng.target_end %}
                        to {{ eng.target_end|date:"SHORT_DATE_FORMAT" }}.
                    {% else %}
                        and is ongoing.
                    {% endif %}
                    {% if eng.test_set %}
                        <br><br>The engagement also included the following tests which may be reported here:<br><br>
                        {% for t in eng.test_set.all %}
                            * {{ t }}
                            ({{ t.environment.name|default:"unknown" }}): {{ t.target_start|date:"SHORT_DATE_FORMAT" }}
                            <br>
                        {% endfor %}
                    {% endif %}
                    {% if eng.test_strategy %}
                        <br>The test strategy for this engagement can be viewed at
                        <a href="{{ eng.test_strategy }}">{{ eng.test_strategy }}</a><br><br>
                    {% else %}
                        <br>
                    {% endif %}
                {% endfor %}
            {% else %}
                No engagements found for {{ product.name }} <br><br>
            {% endif %}
            A total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying severity are
            represented in this report.
        {% endif %}
        {% if engagement %}
            <br>
            {% if engagement.name  and engagement.name|length > 0 %}
                The {{ engagement.name }}
            {% else %}
                An
            {% endif %}
            engagement ran from {{ engagement.target_start|date:"SHORT_DATE_FORMAT" }}
            {% if engagement.target_end %}
                to {{ engagement.target_end|date:"SHORT_DATE_FORMAT" }}.
            {% else %}
                and is ongoing.
            {% endif %}
            {% if engagement.test_set %}
                <br><br>The engagement also included the following tests which may be reported here:<br><br>
                {% for t in engagement.test_set.all %}
                    * {{ t }}
                    ({{ t.environment.name|default:"unknown" }}): {{ t.target_start|date:"SHORT_DATE_FORMAT" }}<br>
                {% endfor %}
            {% endif %}
            {% if engagement.test_strategy %}
                <br>The test strategy for this engagement can be viewed at
                <a href="{{ engagement.test_strategy }}">{{ engagement.test_strategy }}</a><br><br>
            {% else %}
                <br>
            {% endif %}
            A total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying severity are
            represented in this report.
        {% endif %}
        {% if test %}
            <br>
            A {{ test }} was conducted in the {{ test.environment.name }} environment
            {% if test.target_end %}
                from {{ test.target_start|date:"SHORT_DATE_FORMAT" }} to {{ test.target_end|date:"SHORT_DATE_FORMAT" }}
            {% else %}
                on {{ test.target_start|date:"SHORT_DATE_FORMAT" }}
            {% endif %}
            which yielded a total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying
            severity.<br><br>
            The test was part of
            {% if test.engagement.name %}
                the {{ test.engagement.name }}
            {% else %}
                an
            {% endif %}
            engagement which ran from {{ test.engagement.target_start|date:"SHORT_DATE_FORMAT" }}
            {% if test.engagement.target_end %}
                to {{ test.engagement.target_end|date:"SHORT_DATE_FORMAT" }}.
            {% else %}
                and is ongoing.
            {% endif %}
            <br><br>
            {% if test.engagement.test_set %}
                The engagement also included the following tests which are not reported here:<br><br>
                {% for t in test.engagement.test_set.all %}
                    {% if test.id != t.id %}
                        * {{ t }}
                        ({{ t.environment.name|default:"unknown" }}): {{ t.target_start|date:"SHORT_DATE_FORMAT" }}<br>
                    {% endif %}
                {% endfor %}
                </ul>
            {% endif %}
        {% endif %}
        </p>
    {% endif %}
    {% if include_disclaimer%}
        <h4>== Disclaimer ==</h4>
        <h5>{{ disclaimer }}</h5>
    {% endif %}
    <br>
    {% if test %}
        {% with notes=test.notes.all|get_public_notes %}
            <h3>== Test Notes ==</h3>
            <p class="m20">
                {% if notes %}
                    {% for note in notes reversed %}
                        {{ note.author }} - {{ note.date }} - {{ note }} +<br>
                    {% endfor %}
                {% endif %}
            </p>
            <br>
        {% endwith %}
    {% endif %}

    {% if engagement.test_set.all %}
        <h3 id="test_notes">== Test Notes ==</h3>
        <p>
            {% for test in engagement.test_set.all %}
                {% with notes=test.notes.all|get_public_notes %}
                    {% if notes %}
                        {% for note in notes reversed %}
                            {{ note.author }} - {{ note.date }} - {{ note }} +<br>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            {% endfor %}
        </p>
        <br>
    {% endif %}

    {% if engagement.risk_acceptance.count %}
        <h3 id="risk_acceptance">== ?Risk Accepted Findings ==</h3>
        |===<br>
        |Name |Date |Severity<br>
        {% for risk in engagement.risk_acceptance.all %}
            {% for finding in risk.accepted_findings.all %}
                |{{ finding.title }}<br>
                |{{ finding.date }}<br>
                |{{ finding.severity }}<br>
            {% endfor %}
        {% endfor %}
        |===<br>
        <br>
    {% endif %}

    {% if findings %}
        <h3>== Findings ==</h3>
        <br>
    {% endif %}

    {% for find in findings %}
        <h4>==== Finding {{ find.id }}: {{ find.title | nice_title }} {% if find.mitigated %}
            Mitigated on: {{ find.mitigated }} {% endif %}
            {% if find.tags %}
                <sup>
                    [
                    {% for tag in find.tags.all %}
                    {{ tag }}
                    {% endfor %}
                    ]
                </sup>
            {% endif %}  ====
        </h4>
        <br>
        <p><b>==== Product: ====</b>
            <br>
            {{ find.test.engagement.product.name }}
        </p>
        <br>
        <p><b>==== Status: ====</b>
            <br>
            {{ find.status }}
        </p>
        <br>
        <p><b>==== CVSS v3: ====</b>
            <br>
            {{ find.cvssv3 }}
        </p>
        <br>
        <p><b>==== Severity: ====</b>
            <br>
<span style="color:
        {% if find.severity == 'Critical' %} Red
        {% elif find.severity == 'High' %} Magenta
        {% elif find.severity == 'Medium' %} Orange
        {% elif find.severity == 'Low' %} #00CC00
        {% elif find.severity == 'Info' %} Blue {% endif %}">
{{ find.severity }} ({{ find.numerical_severity }})
</span>
        </p>
        <p><b>==== Description / Exploit: ====</b>
            <br>
            {{ find.description|linebreaksbr }}
        </p>
        <br>
        <p><b>==== Impact: ====</b>
            <br>
            {{ find.impact|linebreaksasciidocbr }}
        </p>
        <br>

        {% with endpoints=find|get_vulnerable_endpoints %}
            {% if endpoints %}
                <p><b>==== Vulnerable Endpoints: ====</b><br>
                    {% for endpoint in endpoints %}
                        {{ endpoint }} +<br/>
                    {% endfor %}
                </p>
                <br>
            {% endif %}
        {% endwith %}

        {% with endpoints=find|get_mitigated_endpoints %}
            {% if endpoints %}
                <p><b>==== Remediated Endpoints: ====</b><br>
                    {% for endpoint in endpoints %}
                        {{ endpoint }} +<br/>
                    {% endfor %}
                </p>
                <br>
            {% endif %}
        {% endwith %}

        <p><b>==== Suggested Mitigation: ====</b>
            <br>
            {{ find.mitigation|linebreaksasciidocbr }}
        </p>
        <br>
        <p><b>==== Further References: ====</b>
            <br>
            {{ find.references|linebreaksasciidocbr }}
        </p>
        <br>
        {% if include_finding_images %}
            <p><b>==== Finding Images: ====</b>
                <br>
                {% include "dojo/snippets/file_images.html" with size='small' obj=find format="AsciiDoc" %}
            </p><br>
        {% else %}
            <br>
        {% endif %}

        {% if include_finding_notes %}
            {% with notes=find.notes.all|get_public_notes %}
                {% if notes.count > 0 %}
                    <p><b>==== Finding Notes: ====</b>
                        <br>
                        {% if notes|get_notetype_notes_count > 0 %}
                            {% for note in notes reversed %}
                                    {{ note.author }} - {{ note.date }} - {% if note.note_type != None %}{{ note.note_type }}{% endif %} - {{ note }} +<br>
                            {% endfor %}
                        {% else %}
                            {% for note in notes reversed %}
                                    {{ note.author }} - {{ note.date }} - {{ note }} +<br>
                            {% endfor %}
                        {% endif %}
                    </p><br>
                {% endif %}
            {% endwith %}
        {% endif %}

    {% endfor %}

    {% if mitigated_findings %}
        <h3>== Mitigated Findings ==</h3>
        <br>
        {% for find in mitigated_findings %}
            <h4>=== Finding {{ find.id }}: {{ find.title | nice_title }} {% if find.mitigated %}
                Mitigated on: {{ find.mitigated }} {% endif %}===</h4>
            <br>
            <p><b>==== Severity: ====</b><br>
<span style="color:
        {% if find.severity == 'Critical' %} Red
        {% elif find.severity == 'High' %} Magenta
        {% elif find.severity == 'Medium' %} Orange
        {% elif find.severity == 'Low' %} #00CC00
        {% elif find.severity == 'Info' %} Blue {% endif %}">
{{ find.severity }} ({{ find.numerical_severity }})
</span>
            </p><br>
            <p><b>==== Description / Exploit: ====</b>
                <br>
                {{ find.description|linebreaksasciidocbr }}
            </p>
            {% if include_finding_images %}
                <p><b>==== Finding Images: ====</b>
                    <br>
                    {% include "dojo/snippets/file_images.html" with size='small' obj=find format="AsciiDoc" %}
                </p><br>
            {% else %}
                <br>
            {% endif %}

            {% if include_finding_notes %}
                {% with notes=find.notes.all|get_public_notes %}
                    {% if notes.count > 0 %}
                        <br>
                        <p><b>==== Finding Notes: ====</b>
                            <br>
                            {% if notes|get_notetype_notes_count > 0 %}
                                {% for note in notes reversed %}
                                        {{ note.author }} - {{ note.date }} - {% if note.note_type != None %}{{ note.note_type }}{% endif %} - {{ note }} +<br>
                                {% endfor %}
                            {% else %}
                                {% for note in notes reversed %}
                                        {{ note.author }} - {{ note.date }} - {{ note }} +<br>
                                {% endfor %}
                            {% endif %}
                        </p><br>
                    {% endif %}
                {% endwith %}
            {% endif %}
        {% endfor %}
    {% endif %}
    {% if endpoints %}
        <h3>== Endpoints ==</h3>
        {% for endpoint in endpoints %}
            <h4>=== {{ endpoint }} ===</h4>
            {% for find in endpoint.active_findings %}
                <h5>==== Finding {{ find.id }}: {{ find.title | nice_title }} {% if find.mitigated %}
                    Mitigated on: {{ find.mitigated }} {% endif %}====</h5>
                <br>
                <p><b>==== Product: ====</b>
                    <br>
                    {{ find.test.engagement.product.name }}
                </p>
                <br>
                <p><b>==== Status: ====</b>
                    <br>
                    {{ find.status }}
                </p>
                <br>
                <p><b>==== Severity: ====</b>
                    <br>
<span style="color:
        {% if find.severity == 'Critical' %} Red
        {% elif find.severity == 'High' %} Magenta
        {% elif find.severity == 'Medium' %} Orange
        {% elif find.severity == 'Low' %} #00CC00
        {% elif find.severity == 'Info' %} Blue {% endif %}">
{{ find.severity }} ({{ find.numerical_severity }})
</span>
                </p>
                <p><b>==== Description / Exploit: ====</b>
                    <br>
                    {{ find.description|linebreaksbr }}
                </p>
                <br>
                <p><b>==== Impact: ====</b>
                    <br>
                    {{ find.impact|linebreaksasciidocbr }}
                </p>
                <br>
                {% with endpoints=find|get_vulnerable_endpoints %}
                    {% if endpoints %}
                        <p><b>==== Vulnerable Endpoints: ====</b><br>
                            {% for endpoint in endpoints %}
                                {{ endpoint }} +<br/>
                            {% endfor %}
                        </p>
                        <br>
                    {% endif %}
                {% endwith %}

                {% with endpoints=find|get_mitigated_endpoints %}
                    {% if endpoints %}
                        <p><b>==== Remediated Endpoints: ====</b><br>
                            {% for endpoint in endpoints %}
                                {{ endpoint }} +<br/>
                            {% endfor %}
                        </p>
                        <br>
                    {% endif %}
                {% endwith %}
                <br>
                <p><b>==== Suggested Mitigation: ====</b>
                    <br>
                    {{ find.mitigation|linebreaksasciidocbr }}
                </p>
                <br>
                <p><b>==== Further References: ====</b>
                    <br>
                    {{ find.references|linebreaksasciidocbr }}
                </p>
                <br>
                {% if include_finding_images %}
                    <p><b>==== Finding Images: ====</b>
                        <br>
                        {% include "dojo/snippets/file_images.html" with size='small' obj=find format="AsciiDoc" %}
                    </p><br>
                {% else %}
                    <br>
                {% endif %}
                <br>

                {% if include_finding_notes %}
                    {% with notes=find.notes.all|get_public_notes %}
                        {% if notes.count > 0 %}
                            <br>
                            <p><b>==== Finding Notes: ====</b>
                                <br>
                                {% if notes|get_notetype_notes_count > 0 %}
                                    {% for note in notes reversed %}
                                            {{ note.author }} - {{ note.date }} - {% if note.note_type != None %}{{ note.note_type }}{% endif %} - {{ note }} +<br>
                                    {% endfor %}
                                {% else %}
                                    {% for note in notes reversed %}
                                            {{ note.author }} - {{ note.date }} - {{ note|linebreaks }} +<br>
                                    {% endfor %}
                                {% endif %}
                            </p><br>
                        {% endif %}
                    {% endwith %}
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endif %}
    {% if include_table_of_contents %}
        </div>
	{% endif %}
{% endblock %}
{% block postscript %}
    {{ block.super }}
    <script type="text/javascript">

        window.onload = function () {
            var toc = "";
            var level = 3;

            document.getElementById("contents").innerHTML =
                document.getElementById("contents").innerHTML.replace(
                    /<h([\d])([^<]*)>([^<]+)<\/h([\d])>|<h([\d])([^>]*)>([^<]+)<sup>([^<]*)<\/sup>([^<]*)<\/h([\d])>/gi,
                    function (str, openLevel, id, titleText, closeLevel, openLevel_t, id_t, titleText_t, tags, junk, closeLevel_t) {
                        if (openLevel != closeLevel || openLevel > 5) {
                            return str;
                        }

                        if(tags)
                        {
                            openLevel = openLevel_t;
                            id = id_t;
                            titleText = titleText_t;
                            closeLevel = closeLevel_t;
                        }

                        if (openLevel > level) {
                            toc += (new Array(openLevel - level + 1)).join("<ul>");
                        } else if (openLevel < level) {
                            toc += (new Array(level - openLevel + 1)).join("</ul>");
                        }

                        level = parseInt(openLevel);

                        var anchor = titleText.trim().replace(/ /g, "_");

                        if(tags)
                        {
                            if (['Info', 'Low', 'Medium', 'High', 'Critical'].indexOf(titleText) >= 0) {
                                toc += "<li><a style=\"font-size:" + (160 - (level * 7)) + "%; color:black;\" href=\"#" + anchor + "\">" +
                                "<span class=\"label severity severity-" + titleText + "\">" + titleText + "</span></a></li>";
                            }
                            else {
                                toc += "<li><a style=\"font-size:" + (160 - (level * 7)) + "%; color:black;\" href=\"#" + anchor + "\">" +
                                titleText + "<sup>" + tags + "</sup></a></li>";
                            }

                            return "<a style=\"color:black;\" name=\"" + anchor + "\"><h" + openLevel + "" + id + ">"
                                + titleText + "<sup>" + tags + "</sup></h" + closeLevel + "></a>";
                        }
                        else
                        {
                            if (['Info', 'Low', 'Medium', 'High', 'Critical'].indexOf(titleText) >= 0) {
                                toc += "<br><li><a style=\"font-size:" + (160 - (level * 7)) + "%; color:black;\" href=\"#" + anchor + "\">" +
                                "<span class=\"label severity severity-" + titleText + "\">" + titleText + "</span></a></li><br>";
                            }
                            else {
                                toc += "<li><a style=\"font-size:" + (160 - (level * 7)) + "%; color:black;\" href=\"#" + anchor + "\">" +
                                titleText + "</a></li>";
                            }

                            return "<a style=\"color:black;\" name=\"" + anchor + "\"><h" + openLevel + "" + id + ">"
                                + titleText + "</h" + closeLevel + "></a>";
                        }

                        return "<a style=\"color:black;\" name=\"" + anchor + "\"><h" + openLevel + "" + id + ">"
                            + titleText + "<sup>" + tags + "</sup></h" + closeLevel + "></a>";
                    }
                );

            if (level) {
                toc += (new Array(level + 1)).join("</ul>");
            }

            document.getElementById("toc").innerHTML += toc;
        };

/*
        window.onload = function () {
            var toc = "";
            var level = 3;

            // Handle all elements exclusive of tags
            document.getElementById("contents").innerHTML =
                document.getElementById("contents").innerHTML.replace(
                    /<h([\d])([^<]*)>([^<]+)<\/h([\d])>/gi,
                    function (str, openLevel, id, titleText, closeLevel) {
                        console.log(titleText)
                        if (openLevel != closeLevel || openLevel > 5) {
                            return str;
                        }

                        if (openLevel > level) {
                            toc += (new Array(openLevel - level + 1)).join("<ul>");
                        } else if (openLevel < level) {
                            toc += (new Array(level - openLevel + 1)).join("</ul>");
                        }

                        level = parseInt(openLevel);
                        var anchor = titleText.trim().replace(/ /g, "_");

                        toc += "<li><a style=\"font-size:" + (140 - (level * 7)) + "%; color:black;\" href=\"#" + anchor + "\">" +
                            titleText.replace(/=/g, "") + "</a></li>";

                        return "<a style=\"color:black;\" name=\"" + anchor + "\"><h" + openLevel + "" + id + ">"
                            + titleText + "</h" + closeLevel + "></a>";
                    }
                );

                // Handle findings with tags
                document.getElementById("contents").innerHTML =
                document.getElementById("contents").innerHTML.replace(
                    /<h([\d])([^<]*)>([^<]+)<sup>([^<]+)<\/sup>([^<]*)<\/h([\d])>/gi,
                    function (str, openLevel, id, titleText, tags, junk, closeLevel) {
                        if (openLevel != closeLevel || openLevel > 5) {
                            return str;
                        }

                        if (openLevel > level) {
                            toc += (new Array(openLevel - level + 1)).join("<ul>");
                        } else if (openLevel < level) {
                            toc += (new Array(level - openLevel + 1)).join("</ul>");
                        }

                        level = parseInt(openLevel);
                        var anchor = titleText.trim().replace(/ /g, "_");

                        toc += "<li><a style=\"font-size:" + (140 - (level * 7)) + "%; color:black;\" href=\"#" + anchor + "\">" +
                        titleText.replace(/=/g, "") + "<sup>" + tags + "</sup></a></li>";

                        return "<a style=\"color:black;\" name=\"" + anchor + "\"><h" + openLevel + "" + id + ">"
                            + titleText + "<sup>" + tags + "</sup></h" + closeLevel + "></a>";
                    }
                );

            if (level) {
                toc += (new Array(level + 1)).join("</ul>");
            }

            document.getElementById("toc").innerHTML += toc;
        };
*/
    </script>
{% endblock %}

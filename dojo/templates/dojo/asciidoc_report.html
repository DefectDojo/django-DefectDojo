{% extends "base.html" %}
{% block content %}
    {% load event_tags %}
    {% load display_tags %}
    {% load humanize %}
    {% if product_type %}
        <h2>= {{ product_type }} =</h2>
    {% elif product %}
        <h2>= {{ product }} {% if endpoints %} - Endpoints {% endif %}=</h2>
    {% elif engagement %}
        <h2>= {{ engagement.product.name }}: {{ engagement }} =</h2>
    {% elif test %}
        <h2>= {{ test.engagement.product.name }}: {{ test.engagement }}, {{ test }} =</h2>
    {% elif endpoint %}
        <h2>= Endpoint Report =</h2>
        <h2>= {{ endpoint }} =</h2>
    {% endif %}
    Generated By {{ user.get_full_name }} &lt;{{ request.user.email }}&gt;<br>
    Generated On {% now "SHORT_DATE_FORMAT" %}<br>
    {% if include_table_of_contents %}
        :toc:
    {% endif %}
    {% if include_executive_summary and not endpoint %}
        <br>
        <h3>== Executive Summary ==</h3>
        <p>
            {% if product_type %}
                {% for prod in product_type.prod_type.all %}
                    <h4>=== {{ prod.name }} ===</h4><br>

                    {% if prod.engagement_set.all %}
                        {% for eng in prod.engagement_set.all %}
                            {% if eng.name  and eng.name|length > 0 %}
                                The {{ eng.name }}
                            {% else %}
                                An
                            {% endif %}
                            engagement ran from {{ eng.target_start|date:"SHORT_DATE_FORMAT" }}
                            {% if eng.target_end %}
                                to {{ eng.target_end|date:"SHORT_DATE_FORMAT" }}.
                            {% else %}
                                and is ongoing.
                            {% endif %}
                            {% if eng.test_set %}
                                <br><br>The engagement also included the following tests which may be reported here:<br>
                                <br>
                                {% for t in eng.test_set.all %}
                                    * {{ t.test_type.name }}
                                    ({{ t.environment.name|default:"unknown" }}):
                                    {{ t.target_start|date:"SHORT_DATE_FORMAT" }}<br>
                                {% endfor %}
                            {% endif %}
                            {% if eng.test_strategy %}
                                <br>The test strategy for this engagement can be viewed at
                                <a href="{{ eng.test_strategy }}">{{ eng.test_strategy }}</a><br><br>
                            {% else %}
                                <br>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        No engagements found for {{ prod.name }} <br><br>
                    {% endif %}
                {% endfor %}
                A total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying severity are
                represented in this report.
            {% endif %}
        {% if product %}
            {% if product.engagement_set.all %}
                {% for eng in product.engagement_set.all %}
                    <br>
                    {% if eng.name  and eng.name|length > 0 %}
                        The {{ eng.name }}
                    {% else %}
                        An
                    {% endif %}
                    engagement ran from {{ eng.target_start|date:"SHORT_DATE_FORMAT" }}
                    {% if eng.target_end %}
                        to {{ eng.target_end|date:"SHORT_DATE_FORMAT" }}.
                    {% else %}
                        and is ongoing.
                    {% endif %}
                    {% if eng.test_set %}
                        <br><br>The engagement also included the following tests which may be reported here:<br><br>
                        {% for t in eng.test_set.all %}
                            * {{ t.test_type.name }}
                            ({{ t.environment.name|default:"unknown" }}): {{ t.target_start|date:"SHORT_DATE_FORMAT" }}
                            <br>
                        {% endfor %}
                    {% endif %}
                    {% if eng.test_strategy %}
                        <br>The test strategy for this engagement can be viewed at
                        <a href="{{ eng.test_strategy }}">{{ eng.test_strategy }}</a><br><br>
                    {% else %}
                        <br>
                    {% endif %}
                {% endfor %}
            {% else %}
                No engagements found for {{ product.name }} <br><br>
            {% endif %}
            A total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying severity are
            represented in this report.
        {% endif %}
        {% if engagement %}
            <br>
            {% if engagement.name  and engagement.name|length > 0 %}
                The {{ engagement.name }}
            {% else %}
                An
            {% endif %}
            engagement ran from {{ engagement.target_start|date:"SHORT_DATE_FORMAT" }}
            {% if engagement.target_end %}
                to {{ engagement.target_end|date:"SHORT_DATE_FORMAT" }}.
            {% else %}
                and is ongoing.
            {% endif %}
            {% if engagement.test_set %}
                <br><br>The engagement also included the following tests which may be reported here:<br><br>
                {% for t in engagement.test_set.all %}
                    * {{ t.test_type.name }}
                    ({{ t.environment.name|default:"unknown" }}): {{ t.target_start|date:"SHORT_DATE_FORMAT" }}<br>
                {% endfor %}
            {% endif %}
            {% if engagement.test_strategy %}
                <br>The test strategy for this engagement can be viewed at
                <a href="{{ engagement.test_strategy }}">{{ engagement.test_strategy }}</a><br><br>
            {% else %}
                <br>
            {% endif %}
            A total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying severity are
            represented in this report.
        {% endif %}
        {% if test %}
            <br>
            A {{ test.test_type.name }} was conducted in the {{ test.environment.name }} environemnt
            {% if test.target_end %}
                from {{ test.target_start|date:"SHORT_DATE_FORMAT" }} to {{ test.target_end|date:"SHORT_DATE_FORMAT" }}
            {% else %}
                on {{ test.target_start|date:"SHORT_DATE_FORMAT" }}
            {% endif %}
            which yielded a total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying
            severity.<br><br>
            The test was part of
            {% if test.engagement.name %}
                the {{ test.engagement.name }}
            {% else %}
                an
            {% endif %}
            engagement which ran from {{ test.engagement.target_start|date:"SHORT_DATE_FORMAT" }}
            {% if test.engagement.target_end %}
                to {{ test.engagement.target_end|date:"SHORT_DATE_FORMAT" }}.
            {% else %}
                and is ongoing.
            {% endif %}
            <br><br>
            {% if test.engagement.test_set %}
                The engagement also included the following tests which are not reported here:<br><br>
                {% for t in test.engagement.test_set.all %}
                    {% if test.id != t.id %}
                        * {{ t.test_type.name }}
                        ({{ t.environment.name|default:"unknown" }}): {{ t.target_start|date:"SHORT_DATE_FORMAT" }}<br>
                    {% endif %}
                {% endfor %}
                </ul>
            {% endif %}
        {% endif %}
        </p>
    {% endif %}
    <br>
    {% if test %}
        <h3>== Test Notes ==</h3>
        <p class="m20">
            {% if test.notes.all %}
                {% for note in test.notes.all %}
                    {{ note.author }} - {{ note.date }} - {{ note }} +<br>
                {% endfor %}
            {% endif %}
        </p>
        <br>
    {% endif %}
    {% if engagement.test_set.all %}
        <h3 id="test_notes">== Test Notes ==</h3>
        <p>
            {% for test in engagement.test_set.all %}
                {% if test.notes.all %}
                    {% for note in test.notes.all %}
                        {{ note.author }} - {{ note.date }} - {{ note }} +<br>
                    {% endfor %}
                {% endif %}
            {% endfor %}
        </p>
        <br>
    {% endif %}
    {% if engagement.risk_acceptance.count %}
        <h3 id="risk_acceptance">== Accepted Findings ==</h3>
        |===<br>
        |Name |Date |Severity<br>
        {% for risk in engagement.risk_acceptance.all %}
            {% for finding in risk.accepted_findings.all %}
                |{{ finding.title }}<br>
                |{{ finding.date }}<br>
                |{{ finding.severity }}<br>
            {% endfor %}
        {% endfor %}
        |===<br>
        <br>
    {% endif %}
    {% if findings %}
        <h3>== Findings ==</h3>
        <br>
    {% endif %}
    {% for find in findings %}
        <h4>=== Finding {{ find.id }}: {{ find.title | nice_title }} {% if find.mitigated %}
            Mitigated on: {{ find.mitigated }} {% endif %}===</h4>
        <br>
        <p><b>==== Product: ====</b>
            <br>
            {{ find.test.engagement.product.name }}
        </p>
        <br>
        <p><b>==== Status: ====</b>
            <br>
            {{ find.status }}
        </p>
        <br>
        <p><b>==== Severity: ====</b>
            <br>
<span style="color:
        {% if find.severity == 'Critical' %} Red
        {% elif find.severity == 'High' %} Magenta
        {% elif find.severity == 'Medium' %} Orange
        {% elif find.severity == 'Low' %} #00CC00
        {% elif find.severity == 'Info' %} Blue {% endif %}">
{{ find.severity }} ({{ find.numerical_severity }})
</span>
        </p>
        <p><b>==== Description / Exploit: ====</b>
            <br>
            {{ find.description|linebreaksbr }}
        </p>
        <br>
        <p><b>==== Impact: ====</b>
            <br>
            {{ find.impact|linebreaksasciidocbr }}
        </p>
        <br>
        {% if find.endpoints.all %}
            <p><b>==== Systems Vulnerable: ====</b><br>
                {% for endpoint in  find.endpoints.all %}
                    {{ endpoint }} +<br/>
                {% endfor %}
            </p>
            <br>
        {% endif %}

        <p><b>==== Suggested Mitigation: ====</b>
            <br>
            {{ find.mitigation|linebreaksasciidocbr }}
        </p>
        <br>
        <p><b>==== Further References: ====</b>
            <br>
            {{ find.references|linebreaksasciidocbr }}
        </p>
        <br>
        {% if include_finding_images %}
            <p><b>==== Finding Images: ====</b>
                <br>
                {% if find.images.all %}
                    {% for pic in find.images.all %}
                        image::{{ request.scheme }}://{{ request.get_host }}{% pic_token pic 'small' %}[] +<br>
                    {% endfor %}
                {% else %}
                    No images found.
                {% endif %}
            </p><br>
        {% else %}
            <br>
        {% endif %}
        {% if include_finding_notes %}
            <p><b>==== Finding Notes: ====</b>
                <br>
                {% if find.notes.all %}
                    {% for note in find.notes.all %}
                        {{ note.author }} - {{ note.date }} - {{ note }} +<br>
                    {% endfor %}
                {% else %}
                    No notes found.
                {% endif %}
            </p><br>
        {% else %}
            <br>
        {% endif %}
    {% endfor %}
    {% if mitigated_findings %}
        <h3>== Mitigated Findings ==</h3>
        <br>
        {% for find in mitigated_findings %}
            <h4>=== Finding {{ find.id }}: {{ find.title | nice_title }} {% if find.mitigated %}
                Mitigated on: {{ find.mitigated }} {% endif %}===</h4>
            <br>
            <p><b>==== Severity: ====</b><br>
<span style="color:
        {% if find.severity == 'Critical' %} Red
        {% elif find.severity == 'High' %} Magenta
        {% elif find.severity == 'Medium' %} Orange
        {% elif find.severity == 'Low' %} #00CC00
        {% elif find.severity == 'Info' %} Blue {% endif %}">
{{ find.severity }} ({{ find.numerical_severity }})
</span>
            </p><br>
            <p><b>==== Description / Exploit: ====</b>
                <br>
                {{ find.description|linebreaksasciidocbr }}
            </p>
            {% if include_finding_images %}
                <p><b>==== Finding Images: ====</b>
                    <br>
                    {% if find.images.all %}
                        {% for pic in find.images.all %}
                            image::{{ request.scheme }}://{{ request.get_host }}{% pic_token pic 'small' %}[] +<br>
                        {% endfor %}
                    {% else %}
                        No images found.
                    {% endif %}
                </p><br>
            {% else %}
                <br>
            {% endif %}
            {% if include_finding_notes %}
                <br>
                <p><b>==== Finding Notes: ====</b>
                    <br>
                    {% if find.notes.all %}
                        {% for note in find.notes.all %}
                            {{ note.author }} - {{ note.date }} - {{ note }} +<br>
                        {% endfor %}
                    {% else %}
                        No notes found.
                    {% endif %}
                </p><br>
            {% else %}
                <br>
            {% endif %}
        {% endfor %}
    {% endif %}
    {% if endpoints %}
        <h3>== Endpoints ==</h3>
        {% for endpoint in endpoints %}
            <h4>=== {{ endpoint }} ===</h4>
            {% for find in endpoint.active_findings %}
                <h5>==== Finding {{ find.id }}: {{ find.title | nice_title }} {% if find.mitigated %}
                    Mitigated on: {{ find.mitigated }} {% endif %}====</h5>
                <br>
                <p><b>==== Product: ====</b>
                    <br>
                    {{ find.test.engagement.product.name }}
                </p>
                <br>
                <p><b>==== Status: ====</b>
                    <br>
                    {{ find.status }}
                </p>
                <br>
                <p><b>==== Severity: ====</b>
                    <br>
<span style="color:
        {% if find.severity == 'Critical' %} Red
        {% elif find.severity == 'High' %} Magenta
        {% elif find.severity == 'Medium' %} Orange
        {% elif find.severity == 'Low' %} #00CC00
        {% elif find.severity == 'Info' %} Blue {% endif %}">
{{ find.severity }} ({{ find.numerical_severity }})
</span>
                </p>
                <p><b>==== Description / Exploit: ====</b>
                    <br>
                    {{ find.description|linebreaksbr }}
                </p>
                <br>
                <p><b>==== Impact: ====</b>
                    <br>
                    {{ find.impact|linebreaksasciidocbr }}
                </p>
                <br>
                <p><b>==== Systems Vulnerable: ====</b><br>
                    {% for endpoint in  find.endpoints.all %}
                        {{ endpoint }} +<br/>
                    {% endfor %}
                </p>
                <br>
                <p><b>==== Suggested Mitigation: ====</b>
                    <br>
                    {{ find.mitigation|linebreaksasciidocbr }}
                </p>
                <br>
                <p><b>==== Further References: ====</b>
                    <br>
                    {{ find.references|linebreaksasciidocbr }}
                </p>
                <br>
                {% if include_finding_images %}
                    <p><b>==== Finding Images: ====</b>
                        <br>
                        {% if find.images.all %}
                            {% for pic in find.images.all %}
                                image::{{ request.scheme }}://{{ request.get_host }}{% pic_token pic 'small' %}[] +<br>
                            {% endfor %}
                        {% else %}
                            No images found.
                        {% endif %}
                    </p><br>
                {% else %}
                    <br>
                {% endif %}
                <br>
                {% if include_finding_notes %}
                    <p><b>==== Finding Notes: ====</b>
                        <br>
                        {% if find.notes.all %}
                            {% for note in find.notes.all %}
                                {{ note.author }} - {{ note.date }} - {{ note }} +<br>
                            {% endfor %}
                        {% else %}
                            No notes found.
                        {% endif %}
                    </p><br>
                {% else %}
                    <br>
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endif %}
{% endblock %}

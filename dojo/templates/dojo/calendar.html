{% load static %}
{% load i18n %}

{% block head_extra %}
    {{ block.super }}
    <!-- Using locally stored FullCalendar CSS (no external CDN) -->
    <link href="{% static 'vendor/fullcalendar/fullcalendar.min.css' %}" rel="stylesheet" />
{% endblock %}

{% block postscript %}
    {{ block.super }}
    <!-- Using locally stored JS libraries to avoid missing SRI on external CDNs -->
    <script src="{% static 'vendor/fullcalendar/jquery.min.js' %}"></script>
    <script src="{% static 'vendor/fullcalendar/moment.min.js' %}"></script>
    <script src="{% static 'vendor/fullcalendar/fullcalendar.min.js' %}"></script>

    <script>
        $(function () {
            $('#caltype').change(function() {
                $('#calfilter').attr('action', '/calendar/' + $(this).val());
            });

            if (caltype) {
                $('#caltype').val('{{ caltype }}');
                $('#caltype').trigger('change');
            }

            $('#lead').val([{% for lead in leads %} '{{ lead }}', {% endfor %}]);

            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,basicWeek,basicDay'
                },
                editable: false,
                eventLimit: true, // allow "more" link when too many events
                events: [
                    {% if caltype == 'tests' %}
                        {% for t in tests %}
                            {
                                title: '{{ t.engagement.product.name }}: {{ t.engagement.name|default:"Unknown" }} - {{ t.test_type }} ({{ t.lead|default:"Unassigned" }})',
                                start: '{{ t.target_start|date:"c" }}',
                                end: '{{ t.target_end|date:"c" }}',
                                url: '{% url 'view_test' t.id %}',
                                color: {% if t.engagement.active %}'#337ab7'{% else %}'#b9b9b9'{% endif %},
                                overlap: true
                            },
                        {% endfor %}
                    {% else %}
                        {% for e in engagements %}
                            {
                                title: '{{ e.product.name }}: {{ e.name|default:"Unknown" }} ({{ e.lead|default:"Unassigned" }})',
                                start: '{{ e.target_start|date:"c" }}',
                                end: '{{ e.target_end|date:"c" }}',
                                url: '{% url 'view_engagement' e.id %}',
                                color: {% if e.active %}'#337ab7'{% else %}'#b9b9b9'{% endif %},
                                overlap: true
                            },
                        {% endfor %}
                    {% endif %}
                ],
                viewRender: function(view, element) {
                    $('.fc-prev-button').attr('aria-label', '{% trans "Previous month" %}');
                    $('.fc-next-button').attr('aria-label', '{% trans "Next month" %}');
                    $('.fc-month-button').attr('aria-label', '{% trans "Month preview" %}');
                    $('.fc-basicWeek-button').attr('aria-label', '{% trans "Week preview" %}');
                    $('.fc-basicDay-button').attr('aria-label', '{% trans "Day preview" %}');
                },
                dayRender: function(date, cell) {
                    // Highlight Saturdays and Sundays
                    if (date.day() === 0 || date.day() === 6) {
                        cell.css("background-color", "#f0e68c");
                    }
                }
            });
        });
    </script>
{% endblock %}

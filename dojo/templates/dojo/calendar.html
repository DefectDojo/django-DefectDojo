{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block head_extra %}
    {{ block.super }}
    <!-- Local FullCalendar CSS -->
    <link href="{% static 'vendor/fullcalendar/fullcalendar.min.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
<form method="GET" id="calfilter" action="/calendar">
    <div class="container-fluid chosen-container side-by-side">
        <div class="row">
            <div style="display: inline-block;">
                <label for="caltype" class="sr-only">{% trans "Calendar type" %}</label>
                <select data-placeholder="Calendar type" id="caltype" class="chosen-select">
                    <option value="engagements">Engagements</option>
                    <option value="tests">Tests</option>
                </select>
            </div>
            <div style="display: inline-block;">
                <label for="lead" class="sr-only">{% trans "Select users" %}</label>
                <select data-placeholder="All users" multiple id="lead" name="lead" class="chosen-select">
                    <option value="0">All users</option>
                    <option value="-1">Unassigned</option>
                    {% for u in users %}
                        <option value="{{ u.id }}">{{ u.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="display: inline-block;">
                <input class="btn btn-primary" type="submit" value="Apply" />
            </div>
        </div>
    </div>
</form>
<br/><br/>
<div id="calendar"></div>
<br/><br/>
{% endblock %}

{% block postscript %}
    {{ block.super }}
    <!-- Local JS libraries -->
    <script src="{% static 'vendor/fullcalendar/jquery.min.js' %}"></script>
    <script src="{% static 'vendor/fullcalendar/moment.min.js' %}"></script>
    <script src="{% static 'vendor/fullcalendar/fullcalendar.min.js' %}"></script>

    <script>
        $(function () {
            // Update form action dynamically
            $('#caltype').change(function() {
                $('#calfilter').attr('action', '/calendar/' + $(this).val());
            });

            if (caltype) {
                $('#caltype').val('{{ caltype }}');
                $('#caltype').trigger('change');
            }

            $('#lead').val([{% for lead in leads %} '{{ lead }}', {% endfor %}]);

            // Initialize FullCalendar
            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,basicWeek,basicDay' // retain the comment please
                },
                editable: false,
                eventLimit: true, // allow "more" link when too many events

                // Render events
                events: [
                    {% if caltype == 'tests' %}
                        {% for t in tests %}
                            {
                                title: '{{ t.engagement.product.name }}: {{ t.engagement.name|default:"Unknown" }} - {{ t.test_type }} ({{ t.lead|default:"Unassigned" }})',
                                start: '{{ t.target_start|date:"c" }}',
                                end: '{{ t.target_end|date:"c" }}',
                                url: '{% url 'view_test' t.id %}',
                                color: {% if t.engagement.active %}'#337ab7'{% else %}'#b9b9b9'{% endif %},
                                overlap: true
                            },
                        {% endfor %}
                    {% else %}
                        {% for e in engagements %}
                            {
                                title: '{{ e.product.name }}: {{ e.name|default:"Unknown" }} ({{ e.lead|default:"Unassigned" }})',
                                start: '{{ e.target_start|date:"c" }}',
                                end: '{{ e.target_end|date:"c" }}',
                                url: '{% url 'view_engagement' e.id %}',
                                color: {% if e.active %}'#337ab7'{% else %}'#b9b9b9'{% endif %},
                                overlap: true
                            },
                        {% endfor %}
                    {% endif %}
                ],

                // Accessibility labels
                viewRender: function(view, element) {
                    $('.fc-prev-button').attr('aria-label', '{% trans "Previous month" %}');
                    $('.fc-next-button').attr('aria-label', '{% trans "Next month" %}');
                    $('.fc-month-button').attr('aria-label', '{% trans "Month preview" %}');
                    $('.fc-basicWeek-button').attr('aria-label', '{% trans "Week preview" %}');
                    $('.fc-basicDay-button').attr('aria-label', '{% trans "Day preview" %}');
                },

                // Highlight weekends
                dayRender: function(date, cell) {
                    // Highlight Saturdays (6) and Sundays (0)
                    if (date.day() === 0 || date.day() === 6) {
                        cell.css("background-color", "#fff8dc"); // light yellow
                    }
                }
            });
        });
    </script>
{% endblock %}

{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% load display_tags %}
{% block add_styles %}
    {{ block.super }}
    form.biweekly-metrics p { display: inline-block;}
    form.biweekly-metrics input {border: 1px solid #ccc;border-radius: 4px;padding: 3px 6px;}
    form.biweekly-metrics select {border-radius: 4px;background-color: #fff;background-image: none;border: 1px solid
    #ccc;height: 27px;}
    .errorlist {color: #a94442; display: inline-block;}

    .graph {height: 40vh; width: 100%;}
    .graph-500 {height: 60vh; width: 100%;}

{% endblock %}
{% block content %}
    {{ block.super }}

    {% csrf_token %}
    <form class="biweekly-metrics" action="{% url 'product_type_counts' %}" method="get">
        {{ form.as_p }}
        <input class="btn btn-sm btn-primary" type="submit" value="{% trans "Generate Metrics For Selected Period" %}"/>
    </form>
<script>
        function fillProducts() {
            $.ajax({
                data: {'prod_types': JSON.stringify($("#id_product_type").val()), 'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()},
                method: "POST",
                url: "{% url 'ajax_product_refresh' %}",
                beforeSend: function (jqXHR, settings) {
                    // Pull the token out of the DOM.
                    jqXHR.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]').val());
                },
                success: function (response) {
                    $("#id_product").empty()

                    option = document.createElement('option')
                    option.value = ''
                    option.text = '---------'
                    $("#id_product").append(option)

                    response.forEach((x) => {
                        option = document.createElement('option')
                        option.value = x['id']
                        option.text = x['name']

                        $("#id_product").append(option)
                    })

                    $('.selectpicker').selectpicker('refresh');
                },
                error: function (response) {
                  console.log(response.responseJSON.errors)
                }
            });
            return false;
        }

        function setProductType() {
            $.ajax({
                data: {'products': JSON.stringify($("#id_product").val()), 'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()},
                method: "POST",
                url: "{% url 'ajax_product_type_refresh' %}",
                beforeSend: function (jqXHR, settings) {
                    // Pull the token out of the DOM.
                    jqXHR.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]').val());
                },
                success: function (response) {
                    if (response['ids']) {
                        $('#id_product_type').val(response['ids']);
                        $('.selectpicker').selectpicker('refresh');
                    }
                },
                error: function (response) {
                  console.log(response.responseJSON.errors)
                }
            });
            return false;
        }

        $("#id_product_type").on('change', fillProducts)
        $("#id_product").on('change', setProductType)

        function hideTr() {
            let tr_created = $('#id_tr_created')[0];
            let tr_closed = $('#id_tr_closed')[0];
            let tr_trend = $('#id_tr_trend')[0];
            let tr_empty = $('#id_tr_empty')[0];

            tr_empty.hidden = !tr_empty.hidden;
            tr_created.hidden = !tr_created.hidden;
            tr_closed.hidden = !tr_closed.hidden;
            tr_trend.hidden = !tr_trend.hidden;
        }
    </script>
    <br/>
    {% if pts %}
        <h2>{% blocktrans %} Finding Information For Period of {% endblocktrans %} {{ start_date.date }} - {{ end_date.date }}</h2>
        {% for pt in pts %}
            <h3 class="inline-block">{{ pt.name }}</h3>
            [<a href="{% url 'product_type_metrics' pt.id %}" class="inline-block">{% trans "View Details" %}</a>]
            <br/>
        {% endfor %}
        <br/>
        {% if products %}
            {% for product in products %}
                <h5>{{ product.name }}</h5>
            {% endfor %}
            <br/>
        {% else %}
            <br/>
        {% endif %}

        <div class="panel panel-default table-responsive">
            <div class="panel-heading">
                <h4>{% trans "Total Security Bug Count In Period" %}</h4>
            </div>
            <table class="table table-bordered table-condensed table-striped">
                <thead>
                <tr>
                    <th></th>
                    <th>{% trans "Critical" %}</th>
                    <th>{% trans "High" %}</th>
                    <th>{% trans "Medium" %}</th>
                    <th>{% trans "Low" %}</th>
                    <th>{% trans "Total" %}</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td onclick="hideTr()">
                        <a href="#">
                            {% trans "Total" %}
                        </a>
                    </td>
                    <td>
                        <div data-toggle="tooltip" data-placement="bottom" data-html="true" title="{% trans "Opened" %}: +{{ opened_in_period.S0 }} <br/> {% trans "Closed" %}: -{{ closed_in_period.S0 }} <br/> ---------- <br/> {% trans "Trend" %}: {{ diff_in_pt.S0 }}">
                            {{ overall_in_pt.S0|default_if_none:0 }}
                        </div>
                    </td>
                    <td>
                        <div data-toggle="tooltip" data-placement="bottom" data-html="true" title="{% trans "Opened" %}: +{{ opened_in_period.S1 }} <br/> {% trans "Closed" %}: -{{ closed_in_period.S1 }} <br/> ---------- <br/> {% trans "Trend" %}: {{ diff_in_pt.S1 }}">
                            {{ overall_in_pt.S1|default_if_none:0 }}
                        </div>
                    </td>
                    <td>
                        <div data-toggle="tooltip" data-placement="bottom" data-html="true" title="{% trans "Opened" %}: +{{ opened_in_period.S2 }} <br/> {% trans "Closed" %}: -{{ closed_in_period.S2 }} <br/> ---------- <br/> {% trans "Trend" %}: {{ diff_in_pt.S2 }}">
                            {{ overall_in_pt.S2|default_if_none:0 }}
                        </div>
                    </td>
                    <td>
                        <div data-toggle="tooltip" data-placement="bottom" data-html="true" title="{% trans "Opened" %}: +{{ opened_in_period.S3 }} <br/> {% trans "Closed" %}: -{{ closed_in_period.S3 }} <br/> ---------- <br/> {% trans "Trend" %}: {{ diff_in_pt.S3 }}">
                            {{ overall_in_pt.S3|default_if_none:0 }}
                        </div>
                    </td>
                    <td>
                        <div data-toggle="tooltip" data-placement="bottom" data-html="true" title="{% trans "Opened" %}: +{{ opened_in_period.Total }} <br/> {% trans "Closed" %}: -{{ closed_in_period.Total }} <br/> ---------- <br/> {% trans "Trend" %}: {{ diff_in_pt.Total }}">
                            {{ overall_in_pt.Total|default_if_none:0 }}
                        </div>
                    </td>
                </tr>
                <tr id="id_tr_empty" hidden>
                    <td colspan="6"></td>
                </tr>
                <tr id="id_tr_created" hidden>
                    <td>
                        {% trans "Created" %}
                    </td>
                    <td>
                        {{ opened_in_period.S0|default_if_none:0 }}
                    </td>
                    <td>
                        {{ opened_in_period.S1|default_if_none:0 }}
                    </td>
                    <td>
                        {{ opened_in_period.S2|default_if_none:0 }}
                    </td>
                    <td>
                        {{ opened_in_period.S3|default_if_none:0 }}
                    </td>
                    <td>
                        {{ opened_in_period.Total|default_if_none:0 }}
                    </td>
                </tr>
                <tr id="id_tr_closed" hidden>
                    <td>
                        {% trans "Closed" %}
                    </td>
                    <td>
                        {{ closed_in_period.S0|default_if_none:0 }}
                    </td>
                    <td>
                        {{ closed_in_period.S1|default_if_none:0 }}
                    </td>
                    <td>
                        {{ closed_in_period.S2|default_if_none:0 }}
                    </td>
                    <td>
                        {{ closed_in_period.S3|default_if_none:0 }}
                    </td>
                    <td>
                        {{ closed_in_period.Total|default_if_none:0 }}
                    </td>
                </tr>
                <tr id="id_tr_trend" hidden>
                    <td>
                        {% trans "Trend" %}
                    </td>
                    <td>
                        {{ diff_in_pt.S0|default_if_none:0 }}
                    </td>
                    <td>
                        {{ diff_in_pt.S1|default_if_none:0 }}
                    </td>
                    <td>
                        {{ diff_in_pt.S2|default_if_none:0 }}
                    </td>
                    <td>
                        {{ diff_in_pt.S3|default_if_none:0 }}
                    </td>
                    <td>
                        {{ diff_in_pt.Total|default_if_none:0 }}
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <br/>
        <div class="row">
            <div class="col-md-6 table-responsive">
                <div class="panel-heading">
                    <h4>{% trans "Trending Total Bug Count By Month" %}</h4>
                </div>
                <table class="table table-bordered table-condensed table-striped">
                    <thead>
                    <tr>
                        <th>{% trans "Month" %}</th>
                        <th>{% trans "Critical" %}</th>
                        <th>{% trans "High" %}</th>
                        <th>{% trans "Medium" %}</th>
                        <th>{% trans "Low" %}</th>
                        <th>{% trans "Opened in Month" %}</th>
                        <th>{% trans "Active to Date" %}</th>
                        <th>{% trans "Total Closed" %}<sup>*</sup></th>
                        <th>{% trans "Closed To Date" %}<sup>*</sup></th>
                    </tr>
                    </thead>
                    <tfoot style="font-size: 12px;" class="text-info">
                    <tr>
                        <td colspan="9"><sup>*</sup>{% trans "Closed findings may have been opened outside of requested period." %}</td>
                    </tr>
                    </tfoot>
                    <tbody>
                    {% for to in trending_opened reversed %}
                        <tr>
                            <td>{{ to.start_date.date|date:"M-Y" }}</td>
                            <td>
                                {{ to.S0|default_if_none:0 }}
                            </td>
                            <td>
                                {{ to.S1|default_if_none:0 }}
                            </td>
                            <td>
                                {{ to.S2|default_if_none:0 }}
                            </td>
                            <td>
                                {{ to.S3|default_if_none:0 }}
                            </td>
                            <td>
                                {{ to.Total|default_if_none:0 }}
                            </td>
                            <td>
                                {{ to.to_date_total|default_if_none:0 }}
                            </td>
                            <td>
                                {{ to.closed|default_if_none:0 }}
                            </td>
                            <td>
                                {{ to.to_date_closed|default_if_none:0 }}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <div>
                    <div>
                        <h4>{% trans "Total Active and Closed To Date" %}</h4>
                    </div>
                    <!-- /.panel-heading -->
                    <div class="panel-body">
                        <div id="total_active_and_closed" class="graph"></div>
                    </div>
                    <!-- /.panel-body -->
                </div>
                <!-- /.panel -->
            </div>
        </div>
        <!-- Flot Charts JavaScript -->
        <script src="{% static "flot/jquery.flot.js" %}"></script>
        <script src="{% static "flot/jquery.flot.time.js" %}"></script>
        <script src="{% static "flot/jquery.flot.resize.js" %}"></script>
        <script src="{% static "jquery.flot.tooltip/js/jquery.flot.tooltip.min.js" %}"></script>
        <script>
            function total_active_and_closed(active, closed) {
                var options = {
                    xaxes: [{
                        mode: 'time',
                        timeformat: '%d %b %y'
                    }],
                    yaxes: [{
                        min: 0
                    }],
                    series: {
                        lines: {
                            show: true
                        },
                        points: {
                            show: true
                        }
                    },
                    grid: {
                        hoverable: true,
                        borderWidth: 1,
                        borderColor: '#e7e7e7',
                    },
                    tooltip: true,
                };

                $.plot($("#total_active_and_closed"), [{
                            data: active,
                            label: "{% trans "Active" %}",
                            color: "#d9534f",
                        }, {
                            data: closed,
                            label: "{% trans "Closed" %}",
                            color: '#337ab7',
                        }],
                        options);
            }

            let total_active = [];
            let total_closed = [];
            {% for week in total_by_week %}
                week = {{week|safe}};
                to_date = new Date(week['key']).getTime();
                total_active.push([to_date, week['active']]);
                total_closed.push([to_date, week['closed']]);
            {% endfor %}
            total_active_and_closed(total_active, total_closed);

            $('[data-toggle="tooltip"]').tooltip()
        </script>

        {% if top %}
        <br/>
            <div class="panel panel-default table-responsive">
                <div class="panel-heading">
                    <h4>{% trans "Top By Bug Severity" %}</h4>
                </div>
                <table class="table table-bordered table-condensed table-striped">
                    <thead>
                    <tr>
                        <th>{% trans "Product" %}</th>
                        <th>{% trans "Critical" %}</th>
                        <th>{% trans "High" %}</th>
                        <th>{% trans "Medium" %}</th>
                        <th>{% trans "Low" %}</th>
                        <th>{% trans "Total" %}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for p in top %}
                        <tr>
                            <td>
                                <a title="{{ p.name }}"
                                   href="{% url 'view_product' p.id %}">{{ p.name }}</a>
                            <td>
                                {{ p.critical|default_if_none:0 }}
                            </td>
                            <td>
                                {{ p.high|default_if_none:0 }}
                            </td>
                            <td>
                                {{ p.medium|default_if_none:0 }}
                            </td>
                            <td>
                                {{ p.low|default_if_none:0 }}
                            </td>
                            <td>
                                {{ p.total|default_if_none:0 }}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <br/>
        {% endif %}
        <br/>
        <div class="panel panel-default table-responsive">
            <div class="panel-heading">
                <h4>{% blocktrans %}{{ pt }} Open Findings{% endblocktrans %}</h4>
            </div>
            <table id="open_findings"
                   class="tablesorter-bootstrap table table-bordered table-condensed table-striped table-hover">
                <thead>
                <tr>
                    <th>{% trans "No." %}</th>
                    <th>{% trans "Name" %}</th>
                    <th>{% trans "Date" %}</th>
                    <th>{% trans "Severity" %}</th>
                    <th>{% trans "Age" %}</th>
                    <th>{% trans "Product" %}</th>
                </tr>
                </thead>
                <tbody>
                {% for finding in all_current_in_pt %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td><a title="{{ finding.title }}"
                               href="{% url 'view_finding' finding.id %}">{{ finding.title }}</a>
                        </td>
                        <td class="nowrap">{{ finding.date }}</td>
                        <td>{% if finding.severity == "Critical" or finding.severity == "High" %}
                            <p class="text-danger">
                        {% else %}<p>{% endif %}{{ finding.severity_display }}</p></td>
                        <td>{{ finding.age }}</td>
                        <td><a
                                href="{% url 'view_product' finding.test.engagement.product.id %}"
                                title="{{ finding.test.engagement.product }}">{{ finding.test.engagement.product }}</a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

{% endblock %}
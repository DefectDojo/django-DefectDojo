{% load navigation_tags %}
{% load event_tags %}
{% load static %}
{% block add_css %}
    <link rel="stylesheet" href="{% static "chosen-bootstrap/chosen.bootstrap.min.css" %}">
{% endblock %}
{% block css %}
    {{ form.media.css }}
{% endblock %}
{% block js %}    
    {{ form.media.js }}
{% endblock %}
<div class="filter-set">
    <form method="get" {% if form_id %}id="{{form_id}}"{% endif %} class="{{ request.path|slugify }}-filters form-inline dojo-filter-set">
        {% for field in form.hidden_fields %}
            {{ field }}
        {% endfor %}
        <div class="container-fluid filter-form-group">
            <div class="row gy-4 gx-3" style="overflow-x: hidden;">
                {% for field in form.visible_fields %}
                    <div class="col-lg-3 col-md-4 col-sm-6 col-12">
                        <div class="filter-form-input w-100" style="min-width: 0;">
                            <label for="{{ field.auto_id }}" class="form-label mb-1" style="display: block;">
                                {{ field.label }}
                                {% if field.help_text %}
                                    <i class="fa-solid fa-circle-question has-popover" 
                                       data-trigger="hover" 
                                       data-content="{{ field.help_text }}" 
                                       data-placement="right" 
                                       data-container="body">
                                    </i>
                                {% endif %}
                            </label>
                            {% with placeholder="placeholder:"|add:field.label %}
                              {{ field|addcss:"class: form-control filter-form-control"|addcss:placeholder }}
                            {% endwith %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    {% if submit == 'report' %}
                        {% query_string_as_hidden %}
                        <button class="btn btn-secondary" name="_generate" type="submit">
                            <i class="fa-solid fa-file-lines"></i> Generate Report
                        </button>
                    {% else %}
                        <button id="apply" class="btn btn-secondary">
                            <i class="fa-solid fa-filter"></i> Apply Filters
                        </button>
                        {% if clear_js %}
                            <a class="btn btn-outline-secondary" href="#{{form_id}}" id="clear_js" role="button"> 
                                <i class="fa-solid fa-remove"></i> Clear Filters
                            </a>
                        {% elif clear_link %}
                            <a class="btn btn-outline-secondary" href="{{ clear_link }}" id="clear" role="button"> 
                                <i class="fa-solid fa-remove"></i> Clear Filters
                            </a>
                        {% else %}
                            <a class="btn btn-outline-secondary" href="{{ request.path }}" id="clear" role="button"> 
                                <i class="fa-solid fa-remove"></i> Clear Filters
                            </a>
                        {% endif %}
                        {% if restart_link %}
                            <a href="{{ restart_link }}" id="clear" class="btn btn-outline-secondary">  <i class="fa-solid fa-remove"></i> Restart</a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </form>
</div>
<script>
    $(document).ready(function() {
    const form = $(".filter-set>form");
    $(form).first().submit(function(event) {
      var formData = $(".filter-set>form").first().serializeArray();
      var filteredFormData = formData.filter(function(item) {
        // Remove null or empty values
        return item.value !== "" && item.value !== null && item.value !== 'unknown';
      });
      // Construct the query parameters from the filtered data
      var queryParams = filteredFormData.map(function(item) {
        return encodeURIComponent(item.name) + "=" + encodeURIComponent(item.value);
      });

      // Get the current page's URL
      var currentPageURL = window.location.href;

      // Remove existing query parameters from the current URL
      var baseUrl = currentPageURL.split('?')[0];

      // Append the new query parameters to the base URL
      var newAction = baseUrl + "?" + queryParams.join("&");
      window.location.href = newAction;
      event.preventDefault();
    });

    // Clear filters and related logic
    const clearFilterLink = $("#clear, #clear_js");

    // Check if any filter is applied
    const hasActiveFilters = () => {
    return $(form)
        // We only care about visible inputs as these can be influenced by the user
        .find(":input:not([type='hidden'])")
        .filter(function () {
        const value = $(this).val();

        // Check multi-select dropdowns
        if (Array.isArray(value)) {
            return value.length > 0;
        }

        // Check single values (text inputs/single selects)
        return typeof value === "string" && value.trim() !== "" && value !== "unknown";
        }).length > 0;
    };
      // Update the state of the "Clear filters" link
      const updateClearFiltersState = () => {
        const filtersActive = hasActiveFilters();
        if (clearFilterLink.length) {
          clearFilterLink
            .toggleClass("disabled", !filtersActive)
            .toggleClass("btn-outline-secondary", !filtersActive)
            .toggleClass("btn-secondary", filtersActive);
          clearFilterLink.attr("aria-disabled", !filtersActive);
          clearFilterLink.css("pointer-events", filtersActive ? "auto" : "none");
        }
      };
  
      // Initialize the Clear filters state when page loads
      updateClearFiltersState();
  
      // Trigger Clear filters state on input or dropdown change
      $(form).on("input change", updateClearFiltersState);
  
      // Handle Clear filters link click
      clearFilterLink.click(function (event) {
        if ($(this).attr("aria-disabled") === "true") {
          event.preventDefault();
        } else {
          $(form).trigger("reset"); 
          updateClearFiltersState(); 
        }
      });
  
      // Initialize Chosen plugin for dropdowns
      // This checks if the dropdown has the class 'chosen-select' (dynamically added by other js snippet) 
      // Without this part, bootstrap and chosen styling will conflict and create duplicates for some dropdowns
      $(".chosen-select").chosen({
        allow_single_deselect: true,
        width: "100%", 
      });
    });
  </script>
  
  
{% extends "easy_pdf/base.html" %}
{% load humanize %}
{% block extra_style %}
    <style>
        @page {

            size: {{ pagesize|default:"A4" }};
            margin-left: 1.5cm;
            margin-right: 1.5cm;
            margin-top: 1.5cm;
            margin-bottom: 3cm;
            @frame header_frame { /* Static Frame */
        -pdf-frame-content:header_content;
            left: 50pt;
            width: 512pt;
            top: 50pt;
            height: 40pt;
        }

        @frame footer_frame {
            /* Another static Frame */
        -pdf-frame-content:footer_content;
        left: 50pt; width: 512pt; top: 800pt; height: 30pt;
        }

        }

        body {
            font-size: 14px;
            line-height: 1.3em;
        }

        h1, h2, h3 {
            margin: 0px;
            padding: 0px;
            border: 1px solid #d0d0d0;
            color: white;
        }

        h5 {
            border: 1px solid #d0d0d0;
            margin-top: 0px;
            margin-bottom: 0px;
            padding: 8px 5px 3px 5px;
            background-color: #98AFC7;
            margin-left: 10px;
            margin-right: 10px;
            -pdf-keep-with-next: true;
        }

        h1 {
            background-color: #566D7E;
            padding: 8px 5px 3px 5px;
            color: #f5f5f5
        }

        h2 {
            background-color: #646D7E;
            padding: 8px 5px 3px 5px;
            color: #f5f5f5
        }

        h3 {
            background-color: #616D7E;
            padding: 8px 5px 3px 5px;
            color: #f5f5f5
        }

        h4 {
            background-color: #657383;
            padding: 8px 5px 3px 5px;
            color: #f5f5f5;
            margin-bottom: 0px;
            margin-top: 12px;
            -pdf-keep-with-next: true;
        }

        p.m20 {
            margin-left: 13px;
            margin-right: 13px;
            margin-bottom: 0px;
        }

        p {
            margin-bottom: 25px;
            margin-top: 0px;
            padding: 10px 10px 5px 10px;
            background-color: #f0f0f0;
            border: 1px solid #d0d0d0;
        }

        h1, h2, h3, h4, h5 {
            -pdf-outline: false;
        }

        h3#findings, h3#test_notes, h3#risk_acceptance, h3#exec, h4.finding {
            -pdf-keep-with-next: true;
            -pdf-outline: true
        }

        .toc-h {
            margin-bottom: 15px;
        }

        pdftoc {
            color: #000;
        }

        pdftoc.pdftoclevel0 {
            font-weight: bold;
            margin-top: 0.5em;
        }

        pdftoc.pdftoclevel1 {
            margin-left: 1em;
        }

        pdftoc.pdftoclevel2 {
            margin-left: 2em;

        }

        pdftoc.pdftoclevel3 {
            margin-left: 3em;
            font-style: italic;
        }

        pdftoc.pdftoclevel4 {
            margin-left: 4em;
            font-style: italic;
        }

        table {
            -pdf-keep-in-frame-mode: shrink;
        }

        table {
            background-color: transparent;
        }

        th {
            text-align: center;
        }

        .table {
            width: 100%;
            max-width: 100%;
            margin-bottom: 20px;
            margin-top: 0px;
        }

        .table th,
        .table td {
            padding: 4px;
            vertical-align: top;
            border-top: 1px solid #ddd;
        }

        .table-bordered {
            border: 1px solid #ddd;
        }

        .table-bordered th,
        .table-bordered td {
            border: 1px solid #ddd;
        }
    </style>
{% endblock %}
{% load event_tags %}
{% load display_tags %}
{% block content %}
    <!-- Content for Static Frame 'footer_frame' -->
    <div id="footer_content" style="text-align: center">
        Generated By {{ user.get_full_name }} &lt;{{ request.user.email }}&gt; on {% now "SHORT_DATE_FORMAT" %}<br/>
        Page
        <pdf:pagenumber/>
        of
        <pdf:pagecount/>
    </div>
    {% if product_type %}
        <h1>Product Type Report</h1>
        <h2>{{ product_type }}</h2>
    {% elif product %}
        <h1>Product Report</h1>
        <h2>{{ product }}</h2>
    {% elif engagement %}
        <h1>Engagement Report</h1>
        <h2>{{ engagement.product.name }}: {{ engagement }}</h2>
    {% elif test %}
        <h1>Test Report</h1>
        <h2>{{ test.engagement.product.name }}: {{ test.engagement }}, {{ test }}</h2>
    {% endif %}
    <p>
        Generated By {{ user.get_full_name }} &lt;{{ request.user.email }}&gt;<br/>
        Generated On {% now "SHORT_DATE_FORMAT" %}
    </p>

    {% if include_executive_summary %}
        <h3 id="exec">Executive Summary</h3>
        {% if product_type %}
            {% for prod in product_type.prod_type.all %}
                <h4>{{ prod.name }}</h4><br/>

                {% if prod.engagement_set.all %}
                    {% for eng in prod.engagement_set.all %}
                        {% if eng.name  and eng.name|length > 0 %}
                            The {{ eng.name }}
                        {% else %}
                            An
                        {% endif %}
                        engagement ran from {{ eng.target_start|date:"SHORT_DATE_FORMAT" }}
                        {% if eng.target_end %}
                            to {{ eng.target_end|date:"SHORT_DATE_FORMAT" }}.
                        {% else %}
                            and is ongoing.
                        {% endif %}
                        {% if eng.test_set %}
                            <br/><br/>The engagement also included the following tests which may be reported here:
                            <br/>
                            <ul>
                                {% for t in eng.test_set.all %}
                                    <li>{{ t.test_type.name }}
                                        ({{ t.environment.name|default:"unknown" }}): {{ t.target_start|date:"SHORT_DATE_FORMAT" }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        {% if eng.test_strategy %}
                            <br/>The test strategy for this engagement can be viewed at
                            <a href="{{ eng.test_strategy }}">{{ eng.test_strategy }}</a><br/><br/>
                        {% else %}
                            <br/>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    No engagements found for {{ prod.name }} <br/><br/>
                {% endif %}
            {% endfor %}
            A total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying severity are
            represented in this report.
        {% endif %}
        {% if product %}
            {% if product.engagement_set.all %}
                {% for eng in product.engagement_set.all %}
                    <br/>
                    {% if eng.name  and eng.name|length > 0 %}
                        The {{ eng.name }}
                    {% else %}
                        An
                    {% endif %}
                    engagement ran from {{ eng.target_start|date:"SHORT_DATE_FORMAT" }}
                    {% if eng.target_end %}
                        to {{ eng.target_end|date:"SHORT_DATE_FORMAT" }}.
                    {% else %}
                        and is ongoing.
                    {% endif %}
                    {% if eng.test_set %}
                        <br/><br/>The engagement also included the following tests which may be reported here:
                        <br/>
                        <ul>
                            {% for t in eng.test_set.all %}
                                <li>{{ t.test_type.name }}
                                    ({{ t.environment.name|default:"unknown" }}): {{ t.target_start|date:"SHORT_DATE_FORMAT" }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    {% if eng.test_strategy %}
                        <br/>The test strategy for this engagement can be viewed at
                        <a href="{{ eng.test_strategy }}">{{ eng.test_strategy }}</a><br/><br/>
                    {% else %}
                        <br/>
                    {% endif %}
                {% endfor %}
            {% else %}
                No engagements found for {{ product.name }} <br/><br/>
            {% endif %}
            A total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying severity are
            represented in this report.
        {% endif %}
        {% if engagement %}
            <br/>
            {% if engagement.name  and engagement.name|length > 0 %}
                The {{ engagement.name }}
            {% else %}
                An
            {% endif %}
            engagement ran from {{ engagement.target_start|date:"SHORT_DATE_FORMAT" }}
            {% if engagement.target_end %}
                to {{ engagement.target_end|date:"SHORT_DATE_FORMAT" }}.
            {% else %}
                and is ongoing.
            {% endif %}
            {% if engagement.test_set %}
                <br/><br/>The engagement also included the following tests which may be reported here:
                <br/>
                <ul>
                    {% for t in engagement.test_set.all %}
                        <li>{{ t.test_type.name }}
                            ({{ t.environment.name|default:"unknown" }}): {{ t.target_start|date:"SHORT_DATE_FORMAT" }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            {% if engagement.test_strategy %}
                <br/>The test strategy for this engagement can be viewed at
                <a href="{{ engagement.test_strategy }}">{{ engagement.test_strategy }}</a><br/><br/>
            {% else %}
                <br/>
            {% endif %}
            A total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying severity are
            represented in this report.
        {% endif %}
        {% if test %}
            <br/>
            A {{ test.test_type.name }} was conducted in the {{ test.environment.name }} environemnt
            {% if test.target_end %}
                from {{ test.target_start|date:"SHORT_DATE_FORMAT" }} to {{ test.target_end|date:"SHORT_DATE_FORMAT" }}
            {% else %}
                on {{ test.target_start|date:"SHORT_DATE_FORMAT" }}
            {% endif %}
            which yielded a total of {{ findings|length|apnumber }} finding{{ findings|length|pluralize }} of varying severity.<br/><br/>
            The test was part of
            {% if test.engagement.name %}
                the {{ test.engagement.name  }}
            {% else %}
                an
            {% endif %}
            engagement which ran from {{ test.engagement.target_start|date:"SHORT_DATE_FORMAT" }}
            {% if test.engagement.target_end %}
                to {{ test.engagement.target_end|date:"SHORT_DATE_FORMAT" }}.
            {% else %}
                and is ongoing.
            {% endif %}
            <br/><br/>
            {% if test.engagement.test_set %}
                The engagement also included the following tests which are not reported here:
                <ul>
                {% for t in test.engagement.test_set.all %}
                    {% if test.id != t.id %}
                        <li>{{ t.test_type.name }}
                            ({{ t.environment.name|default:"unknown" }}): {{ t.target_start|date:"SHORT_DATE_FORMAT" }}</li>
                    {% endif %}
                {% endfor %}
                </ul>
            {% endif %}
        {% endif %}
        <br/><br/>
    {% endif %}
    {% if include_table_of_contents %}
        <h3 class="toc-h">Table of Contents</h3>

        <div>
            <pdf:toc/>
        </div>

    {% endif %}
    <p>
        <pdf:nextpage/>
    </p>
    {% if test %}
        <h3 id="test_notes">Test Notes</h3>
        <p>
            {% if test.notes.all %}
                {% for note in test.notes.all %}
                    {{ note.author }} - {{ note.date }} - {{ note }} <br>
                {% endfor %}
            {% else %}
                No notes found.
            {% endif %}
        </p>
    {% endif %}
    {% if engagement.test_set.all %}
        <h3 id="test_notes">Test Notes</h3>

        <p>
            {% for test in engagement.test_set.all %}
                {% if test.notes.all %}
                    {% for note in test.notes.all %}
                        {{ note.author }} - {{ note.date }} - {{ note }} <br>
                    {% endfor %}
                {% endif %}
            {% endfor %}
        </p>
    {% endif %}
    {% if engagement.risk_acceptance.count %}
        <h3 id="risk_acceptance">Accepted Findings</h3>
        <table class="table table-bordered table-striped">
            <tr>
                <th>Name</th>
                <th>Date</th>
                <th>Severity</th>
            </tr>
            {% for risk in engagement.risk_acceptance.all %}
                {% for finding in risk.accepted_findings.all %}
                    <tr>
                        <td>{{ finding.title }}</td>
                        <td>{{ finding.date }}</td>
                        <td>{{ finding.severity }}</td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </table>
    {% endif %}
    <h3 id="findings">Findings</h3>
    {% for find in findings %}
        <h4 style="margin-top: 20px; margin-bottom: 0px; -pdf-outline: false;" class="finding"
            id="finding_{{ find.id }}">Finding {{ forloop.counter | pad_zeroes }}: {{ find.title | nice_title }}
            {% if find.mitigated %}Mitigated on: {{ find.mitigated }} {% endif %}</h4>
        <h5>Product:</h5>
        <p class="m20">
            {{ find.test.engagement.product.name }}
        </p>
        <h5>Status:</h5>
        <p class="m20">
            {{ find.status }}
        </p>
        {% ifchanged find.severity %}
            <h5 style="-pdf-outline: true;">Severity: {{ find.severity }}</h5>
        {% else %}
            <h5>Severity: {{ find.severity }}</h5>
        {% endifchanged %}
        <p class="m20">
                <span style="color:
                        {% if find.severity == 'Critical' %} Red
                        {% elif find.severity == 'High' %} Magenta
                        {% elif find.severity == 'Medium' %} Orange
                        {% elif find.severity == 'Low' %} #00CC00
                        {% elif find.severity == 'Info' %} Blue {% endif %}">
                {{ find.severity }} ({{ find.numerical_severity }})
                </span>
        </p>
        <h5>Description / Exploit:</h5>
        <p class="m20">
            {{ find.description|linebreaksbr }}
        </p>
        <h5>Impact:</h5>
        <p class="m20">
            {{ find.impact|linebreaksbr }}
        </p>
        <h5>Systems Vulnerable:</h5>
        <p class="m20">
            {{ find.endpoint|linebreaksbr }}
        </p>
        <h5>Suggested Mitigation:</h5>
        <p class="m20">
            {{ find.mitigation|linebreaksbr }}
        </p>
        <h5>Further References:</h5>
        <p class="m20">
            {{ find.references|linebreaksbr }}
        </p>
        {% if include_finding_notes %}
            <h5>Finding Notes:</h5>
            <p class="m20">
                {% if find.notes.all %}
                    {% for note in find.notes.all %}
                        {{ note.author }} - {{ note.date }} - {{ note }} <br>
                    {% endfor %}
                {% else %}
                    No notes found.
                {% endif %}
            </p>
        {% endif %}
    {% endfor %}
{% endblock %}

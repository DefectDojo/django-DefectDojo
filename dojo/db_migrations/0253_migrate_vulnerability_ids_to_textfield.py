# Generated migration for migrating Vulnerability_Id_Template to vulnerability_ids_text

from django.db import migrations


def migrate_vulnerability_ids_to_textfield(apps, schema_editor):
    """
    Migrate Vulnerability_Id_Template records to vulnerability_ids_text TextField.
    Converts all vulnerability IDs for each Finding_Template into a newline-separated string.
    """
    Finding_Template = apps.get_model('dojo', 'Finding_Template')
    Vulnerability_Id_Template = apps.get_model('dojo', 'Vulnerability_Id_Template')

    # Process each Finding_Template
    for template in Finding_Template.objects.all():
        # Get all vulnerability IDs for this template
        vuln_ids = Vulnerability_Id_Template.objects.filter(
            finding_template=template
        ).values_list('vulnerability_id', flat=True).order_by('id')

        # Convert to list and remove duplicates while preserving order
        vulnerability_ids = list(dict.fromkeys([vid.strip() for vid in vuln_ids if vid.strip()]))

        # Save as newline-separated string
        if vulnerability_ids:
            template.vulnerability_ids_text = '\n'.join(vulnerability_ids)
            # Also update CVE field for backward compatibility (first ID)
            if not template.cve:
                template.cve = vulnerability_ids[0]
        else:
            # If no vulnerability IDs, check if CVE field has a value
            if template.cve:
                template.vulnerability_ids_text = template.cve
            else:
                template.vulnerability_ids_text = None

        template.save(update_fields=['vulnerability_ids_text', 'cve'])


def reverse_migrate_vulnerability_ids_to_textfield(apps, schema_editor):
    """
    Reverse migration: populate Vulnerability_Id_Template from vulnerability_ids_text.
    Note: This will recreate Vulnerability_Id_Template records if they were deleted.
    """
    Finding_Template = apps.get_model('dojo', 'Finding_Template')
    Vulnerability_Id_Template = apps.get_model('dojo', 'Vulnerability_Id_Template')

    # Process each Finding_Template
    for template in Finding_Template.objects.all():
        # Parse vulnerability_ids_text
        vulnerability_ids = []
        if template.vulnerability_ids_text:
            vulnerability_ids = [
                vid.strip()
                for vid in template.vulnerability_ids_text.split('\n')
                if vid.strip()
            ]

        # Also check CVE field for backward compatibility
        if not vulnerability_ids and template.cve:
            vulnerability_ids = [template.cve]

        # Remove duplicates while preserving order
        vulnerability_ids = list(dict.fromkeys(vulnerability_ids))

        # Delete existing Vulnerability_Id_Template records for this template
        Vulnerability_Id_Template.objects.filter(finding_template=template).delete()

        # Create new Vulnerability_Id_Template records
        for vuln_id in vulnerability_ids:
            Vulnerability_Id_Template.objects.create(
                finding_template=template,
                vulnerability_id=vuln_id
            )


def delete_old_vulnerability_id_templates(apps, schema_editor):
    """
    Delete all Vulnerability_Id_Template records after migration is complete.
    This is a one-way operation and cannot be reversed.
    """
    Vulnerability_Id_Template = apps.get_model('dojo', 'Vulnerability_Id_Template')
    Vulnerability_Id_Template.objects.all().delete()


class Migration(migrations.Migration):

    dependencies = [
        ('dojo', '0252_finding_template_changes'),
    ]

    operations = [
        # Step 1: Migrate data from Vulnerability_Id_Template to vulnerability_ids_text
        migrations.RunPython(
            migrate_vulnerability_ids_to_textfield,
            reverse_code=reverse_migrate_vulnerability_ids_to_textfield,
        ),
        # Step 2: Delete old Vulnerability_Id_Template records
        # Note: This is irreversible - if you need to rollback, you'll need to restore from backup
        migrations.RunPython(
            delete_old_vulnerability_id_templates,
            reverse_code=migrations.RunPython.noop,
        ),
    ]


sudo: required
language: python
install: true

services:
  - docker

before_script:
  - export -f travis_fold
  - export REPO=appsecpipeline/django-defectdojo
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`

jobs:
  include:
    - stage: build docker image
      name: dev-mysql-docker
    - script: docker build --target dev-mysql-self-contained -t $REPO .
    - script: docker build --target release -t $REPO:release .
      name: release
    - stage: tests
      name: smoke-test
      script: bash entrypoint_scripts/test/travis-smoke-test.sh || exit 1
    - script: bash entrypoint_scripts/test/travis-unit-test.sh || exit 1
      name: unit-test
    - script: bash entrypoint_scripts/test/travis-integration-test.sh || exit 1
      name: integration-test
    - script:
        - |
          if [ "$TRAVIS_BRANCH" == "dev" ]
          then
              echo "Running Flake8 tests on dev branch aka pull requests"
              # We need to checkout dev for flake8-diff to work properly
              git checkout dev
              pip install pep8 flake8 flake8-diff
              flake8-diff
          else
            echo "true"
            fi
      name: flake8

after_success:
  #Push to docker repo
  - |
    if [ "$TRAVIS_TAG" != "" ] && [ "$DOCKER_USER" != "" ] && [  "$DOCKER_PASS" != "" ]; then
      docker tag $REPO $REPO:$TRAVIS_TAG
      docker login -u "$DOCKER_USER" -p "$DOCKER_PASS";
      docker push $REPO ;
    fi

notifications:
  slack:
    rooms:
      secure: nPXwHnPcf37yGkCkLimx5UmY9LTtOHL0lw88cAQeXCNNjeZuhS2jS5xGUOwwp3SrsYE4tZhD0WuVEHGDcyIhmBZh9Qqk3NHKz+tQDD/e0GE/8uTTfR1Eh+pq1YOIcLYzzKA2khmJSeHqqDriVZZoWpn67oHtrui9FYesapZ8AX0=
    on_success: never
    on_failure: never
    on_start: never
addons:
  firefox: "45.0"
  chrome: stable

{{- if .Values.createPostgresSecret -}}
apiVersion: v1
kind: Secret
metadata:
  annotations:
    {{- if (not .Values.disableHooks) }}
    helm.sh/resource-policy: keep
    helm.sh/hook: "pre-install"
    helm.sh/hook-delete-policy: "before-hook-creation"
    {{- end }}
    {{- range $key, $value := mergeOverwrite dict .Values.extraAnnotations .Values.secrets.annotations }}
    {{ $key }}: {{ quote $value }}
    {{- end }}
  labels:
    app.kubernetes.io/name: {{ include "defectdojo.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ include "defectdojo.chart" . }}
    {{- range $key, $value := .Values.extraLabels }}
    {{ $key }}: {{ quote $value }}
    {{- end }}
  name: {{ .Values.postgres.auth.existingSecret }}
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
{{- if .Values.postgres.auth.password }}
  {{ .Values.postgres.auth.secretKeys.adminPasswordKey }}: {{ .Values.postgres.auth.password | b64enc | quote }}
{{- else }}
  {{- $postgresRandomPassword := randAlphaNum 16 | b64enc | quote }}
  {{ .Values.postgres.auth.secretKeys.adminPasswordKey }}: {{ $postgresRandomPassword }}
{{- end }}
{{- end }}

---
{{- if .Values.createPostgresSecret -}}
{{- fail "Error: 'createPostgresSecret' value is not supported anymore. Because of license reason, DefectDojo migrated from Bitnami to CloudPirates chart. Use 'createValkeySecret' instead. To be sure that your Postgres is migrated correctly, please follow release notes." }}
{{- end }}
{{- if .Values.postgresql -}}
{{- fail "Error: PostgreSQL values had been migrated to another place. If you have any values in `postgresql:` section in `values.yaml` file, please migrate them to `postgres:` section. If you are using external Postgres instance, related values need to be changed. For more information, please follow release notes." }}
{{- end }}
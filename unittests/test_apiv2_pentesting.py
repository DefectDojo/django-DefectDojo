from django.urls import reverse
from rest_framework.test import APIClient, APITestCase
from rest_framework.authtoken.models import Token
from rest_framework import status
from django.core.files.uploadedfile import SimpleUploadedFile

from dojo.models import Input, InputFile, InputSecret, InputEngagement


class PentestingViewsTestCase(APITestCase):
    fixtures = ["dojo_testdata.json"]

    def setUp(self):
        token = Token.objects.get(user__username="admin")
        self.client = APIClient()
        self.client.credentials(HTTP_AUTHORIZATION="Token " + token.key)
        self.create_file_url = reverse("pentesting-create-scope-file")
        self.create_secret_url = reverse("pentesting-create-scope-secret")
        self.download_url = reverse("pentesting-download-file")
        self.list_file_url = reverse("pentesting-list")
    

    def test_create_scope_file_creates_input_and_file(self):
        """
        POST multipart/form-data to create_scope_file should create Input, InputEngagement and InputFile.
        """
        file_content = b"hello test"
        uploaded = SimpleUploadedFile("test_upload.txt", file_content, content_type="text/plain")
        query = "engagement=1&product=1&description=Test+upload&type=file&file_name=test_upload.txt"
        
        data = {
            "file": uploaded,
        }

        resp = self.client.post(f"{self.create_file_url}?{query}", data, format="multipart")
        assert resp.status_code in (status.HTTP_200_OK, status.HTTP_201_CREATED)

        # verify Input created and related InputFile exists
        created_inputs = Input.objects.filter(description="Test upload")
        assert created_inputs.exists()
        input_instance = created_inputs.first()
        print(InputEngagement.objects.all().values_list("input_id", "engagement_id", "product_id"))
        assert InputEngagement.objects.filter(input=input_instance, engagement_id=1).exists()
        assert InputFile.objects.filter(input=input_instance, file_name__icontains="test_upload.txt").exists()

    def test_create_scope_secret_creates_input_and_secret(self):
        """
        POST JSON to create_scope_secret should create Input, InputEngagement and InputSecret.
        """
        data = {
            "engagement": 1,
            "product": 1,
            "description": "Secret desc",
            "type": "secret",
            "key": "usernamekey",
            "secret": "supersecret"
        }


        resp = self.client.post(f"{self.create_secret_url}", data=data, format="json")
        assert resp.status_code in (status.HTTP_200_OK, status.HTTP_201_CREATED)

        created_inputs = Input.objects.filter(description="Secret desc")
        assert created_inputs.exists()
        input_instance = created_inputs.first()
        assert InputEngagement.objects.filter(input=input_instance, engagement_id=1).exists()
        assert InputSecret.objects.filter(input=input_instance, key="usernamekey").exists()

    def test_list_pentesting_inputs(self):
        """
        Ensure we can list pentesting inputs.
        """
        resp = self.client.get(self.list_file_url)
        assert resp.status_code == status.HTTP_200_OK
        assert "results" in resp.data


    def test_download_file_returns_attachment_and_content(self):
        """
        Ensure download_file returns the stored file as attachment with correct bytes.
        Requires an InputFile linked to Input id=1 in fixtures or created earlier in tests.
        """
        # try to use an existing input with file; if none, create minimal objects
        input_qs = Input.objects.all()
        if not input_qs.exists():
            inp = Input.objects.create(description="dl test", owner_id=1, type="file")
            ie = InputEngagement.objects.create(engagement_id=1, product_id=1, input=inp)
            f = SimpleUploadedFile("dl_test.txt", b"dl content", content_type="text/plain")
            InputFile.objects.create(input=inp, file=f, file_name="dl_test.txt")
            input_id = inp.id
        else:
            # try find an Input that has InputFile
            inp_with_file = Input.objects.filter(inputfile__isnull=False).first()
            if inp_with_file:
                input_id = inp_with_file.id
            else:
                inp = input_qs.first()
                f = SimpleUploadedFile("dl_test.txt", b"dl content", content_type="text/plain")
                InputFile.objects.create(input=inp, file=f, file_name="dl_test.txt")
                input_id = inp.id

        resp = self.client.get(f"{self.download_url}?input={input_id}")
        assert resp.status_code == status.HTTP_200_OK
        cd = resp.get("Content-Disposition", "")
        assert "attachment" in cd.lower()

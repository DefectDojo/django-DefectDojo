<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.79.1"><meta name=description content="Documentation for DefectDojo"><link rel="shortcut icon" href=/django-DefectDojo/images/favicon.ico type=image/x-icon><title>Running in Production :: DefectDojo Documentation</title><link href=/django-DefectDojo/css/nucleus.css?1619336002 rel=stylesheet><link href=/django-DefectDojo/css/fontawesome-all.min.css?1619336002 rel=stylesheet><link href=/django-DefectDojo/css/hybrid.css?1619336002 rel=stylesheet><link href=/django-DefectDojo/css/featherlight.min.css?1619336002 rel=stylesheet><link href=/django-DefectDojo/css/perfect-scrollbar.min.css?1619336002 rel=stylesheet><link href=/django-DefectDojo/css/auto-complete.css?1619336002 rel=stylesheet><link href=/django-DefectDojo/css/atom-one-dark-reasonable.css?1619336002 rel=stylesheet><link href=/django-DefectDojo/css/theme.css?1619336002 rel=stylesheet><link href=/django-DefectDojo/css/hugo-theme.css?1619336002 rel=stylesheet><link href=/django-DefectDojo/css/theme-blue.css?1619336002 rel=stylesheet><script src=/django-DefectDojo/js/jquery-3.3.1.min.js?1619336002></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><style type=text/css>body{max-width:1500px}a#logo{background:#fff}</style></head><body data-url=/django-DefectDojo/running/running-in-production/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=/django-DefectDojo/><img src=/django-DefectDojo/images/logo.png alt="DefectDojo Logo"></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/django-DefectDojo/js/lunr.min.js?1619336002></script><script type=text/javascript src=/django-DefectDojo/js/auto-complete.js?1619336002></script><script type=text/javascript>var baseurl="https:\/\/DefectDojo.github.io\/django-DefectDojo\/";</script><script type=text/javascript src=/django-DefectDojo/js/search.js?1619336002></script></div><div class=highlightable><ul class=topics><li data-nav-id=/django-DefectDojo/basics/ title=Basics class=dd-item><a href=/django-DefectDojo/basics/>Basics</a><ul><li data-nav-id=/django-DefectDojo/basics/about/ title="About DefectDojo" class=dd-item><a href=/django-DefectDojo/basics/about/>About DefectDojo</a></li><li data-nav-id=/django-DefectDojo/basics/models/ title=Models class=dd-item><a href=/django-DefectDojo/basics/models/>Models</a></li><li data-nav-id=/django-DefectDojo/basics/features/ title=Features class=dd-item><a href=/django-DefectDojo/basics/features/>Features</a></li><li data-nav-id=/django-DefectDojo/basics/workflows/ title=Workflows class=dd-item><a href=/django-DefectDojo/basics/workflows/>Workflows</a></li><li data-nav-id=/django-DefectDojo/basics/start-using/ title="Usage Examples" class=dd-item><a href=/django-DefectDojo/basics/start-using/>Usage Examples</a></li></ul></li><li data-nav-id=/django-DefectDojo/integrations/ title=Integrations class=dd-item><a href=/django-DefectDojo/integrations/>Integrations</a><ul><li data-nav-id=/django-DefectDojo/integrations/burp-plugin/ title="Defect Dojo Burp-Plugin" class=dd-item><a href=/django-DefectDojo/integrations/burp-plugin/>Defect Dojo Burp-Plugin</a></li><li data-nav-id=/django-DefectDojo/integrations/api-docs/ title="DefectDojo API Documentation" class=dd-item><a href=/django-DefectDojo/integrations/api-docs/>DefectDojo API Documentation</a></li><li data-nav-id=/django-DefectDojo/integrations/api-v2-docs/ title="DefectDojo API v2 Documentation" class=dd-item><a href=/django-DefectDojo/integrations/api-v2-docs/>DefectDojo API v2 Documentation</a></li><li data-nav-id=/django-DefectDojo/integrations/google-sheets-sync/ title="Google Sheets Sync" class=dd-item><a href=/django-DefectDojo/integrations/google-sheets-sync/>Google Sheets Sync</a></li><li data-nav-id=/django-DefectDojo/integrations/import/ title="Import Reports" class=dd-item><a href=/django-DefectDojo/integrations/import/>Import Reports</a></li><li data-nav-id=/django-DefectDojo/integrations/jira/ title="JIRA Integration" class=dd-item><a href=/django-DefectDojo/integrations/jira/>JIRA Integration</a></li><li data-nav-id=/django-DefectDojo/integrations/social-authentication/ title="Setting up Social Authentication via OAuth2 Providers" class=dd-item><a href=/django-DefectDojo/integrations/social-authentication/>Setting up Social Authentication via OAuth2 Providers</a></li><li data-nav-id=/django-DefectDojo/integrations/slack-notifications/ title="Slack Notifications" class=dd-item><a href=/django-DefectDojo/integrations/slack-notifications/>Slack Notifications</a></li></ul></li><li data-nav-id=/django-DefectDojo/running/ title="Running DefectDojo" class="dd-item
parent"><a href=/django-DefectDojo/running/>Running DefectDojo</a><ul><li data-nav-id=/django-DefectDojo/running/getting-started/ title="Getting Started" class=dd-item><a href=/django-DefectDojo/running/getting-started/>Getting Started</a></li><li data-nav-id=/django-DefectDojo/running/configuration/ title=Configuration class=dd-item><a href=/django-DefectDojo/running/configuration/>Configuration</a></li><li data-nav-id=/django-DefectDojo/running/running-in-production/ title="Running in Production" class="dd-item active"><a href=/django-DefectDojo/running/running-in-production/>Running in Production</a></li><li data-nav-id=/django-DefectDojo/running/upgrading/ title=Upgrading class=dd-item><a href=/django-DefectDojo/running/upgrading/>Upgrading</a></li></ul></li><li data-nav-id=/django-DefectDojo/contributing/ title=Contributing class=dd-item><a href=/django-DefectDojo/contributing/>Contributing</a><ul><li data-nav-id=/django-DefectDojo/contributing/branching-model/ title="Branching Model" class=dd-item><a href=/django-DefectDojo/contributing/branching-model/>Branching Model</a></li><li data-nav-id=/django-DefectDojo/contributing/documentation/ title=Documentation class=dd-item><a href=/django-DefectDojo/contributing/documentation/>Documentation</a></li><li data-nav-id=/django-DefectDojo/contributing/how-to-write-a-parser/ title="How to write a DefectDojo parser" class=dd-item><a href=/django-DefectDojo/contributing/how-to-write-a-parser/>How to write a DefectDojo parser</a></li></ul></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/DefectDojo/django-DefectDojo><i class="fab fa-github"></i>Github repo</a></li><li><a class=padding href=https://demo.defectdojo.org/><i class="fas fa-fw fa-camera"></i>Demo site</a></li></ul></section><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a>from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/DefectDojo/django-DefectDojo/blob/dev/docs/content/running/running-in-production.md target=blank><i class="fas fa-code-branch"></i><span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/django-DefectDojo/>DefectDojo's Documentation</a> > <a href=/django-DefectDojo/running/>Running DefectDojo</a> > Running in Production</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#production-with-docker-compose>Production with docker-compose</a></li><li><a href=#database-performance-and-backup>Database performance and backup</a></li><li><a href=#backup-of-media-files>Backup of Media files</a></li><li><a href=#instance-size>Instance size</a></li><li><a href=#key-processes>Key processes</a><ul><li></li></ul></li><li><a href=#production-with-setupbash>Production with setup.bash</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Running in Production</h1><h2 id=production-with-docker-compose>Production with docker-compose</h2><p>The docker-compose.yml file in this repository is fully functional to evaluate DefectDojo in your local environment.</p><p>Although Docker Compose is one of the supported installation methods to deploy a containerized DefectDojo in a production environment, the docker-compose.yml file is not intended for production use without first customizing it to your particular situation.</p><h2 id=database-performance-and-backup>Database performance and backup</h2><p>It is recommended to use a dedicated database server and not the preconfigured MySQL database. This will improve the performance of DefectDojo</p><p>In both case, if you use a dedicated database server or if you should decide to use the preconfigured MySQL database, make sure to make regular backups of the data. For a dedicated database server follow the instructions that come with the database server. For the preconfigured MySQL you can use mysqldump, e.g. as described in <a href=https://dev.to/grant_bartlett/how-to-backup-a-docker-mysql-database-3nd8>How to backup a Docker MySQL database</a>.</p><h2 id=backup-of-media-files>Backup of Media files</h2><p>Media files for uploaded files, including threat models and risk acceptance, are stored in a docker volume. This volume needs to be backed up regularly.</p><h2 id=instance-size>Instance size</h2><div class="notices note"><p>Please read the paragraphs below about key processes tweaks.</p></div><p>Having taken the database to run elsewhere, the minimum recommendation
is:</p><ul><li>2 vCPUs</li><li>8 GB of RAM</li><li>2 GB of disk space (remember, your database is not here -- so
basically, what you have for your O/S should do). You could allocate
a different disk than your OS's for potential performance
improvements.</li></ul><h2 id=key-processes>Key processes</h2><p>Per <a href=https://github.com/DefectDojo/django-DefectDojo/pull/2813>https://github.com/DefectDojo/django-DefectDojo/pull/2813</a>, it is
now easy to somewhat improve the uWSGI and celery worker performance.</p><h4 id=uwsgi>uWSGI</h4><p>By default (except in <code>ptvsd</code> mode for debug purposes), uWSGI will
handle 4 concurrent connections.</p><p>Based on your resource settings, you can tweak:</p><ul><li><code>DD_UWSGI_NUM_OF_PROCESSES</code> for the number of spawned processes.
(default 2)</li><li><code>DD_UWSGI_NUM_OF_THREADS</code> for the number of threads in these
processes. (default 2)</li></ul><p>For example, you may have 4 processes with 6 threads each, yielding 24
concurrent connections.</p><h4 id=celery-worker>Celery worker</h4><p>By default, a single mono-process celery worker is spawned. This is fine
until you start having many findings, and when async operations like
deduplication start to kick in. Eventually, it will starve your
resources and crawl to a halt, while operations continue to queue up.</p><p>The following variables will help a lot, while keeping a single celery
worker container.</p><ul><li><code>DD_CELERY_WORKER_POOL_TYPE</code> will let you switch to <code>prefork</code>.
(default <code>solo</code>)</li></ul><p>As you've enabled [prefork]{.title-ref}, the following variables have
to be used. The default are working fairly well, see the
Dockerfile.django for in-file references.</p><ul><li><code>DD_CELERY_WORKER_AUTOSCALE_MIN</code> defaults to 2.</li><li><code>DD_CELERY_WORKER_AUTOSCALE_MAX</code> defaults to 8.</li><li><code>DD_CELERY_WORKER_CONCURRENCY</code> defaults to 8.</li><li><code>DD_CELERY_WORKER_PREFETCH_MULTIPLIER</code> defaults to 128.</li></ul><p>You can execute the following command to see the configuration:</p><p><code>docker-compose exec celerybeat bash -c "celery -A dojo inspect stats"</code>
and see what is in effect.</p><h2 id=production-with-setupbash>Production with setup.bash</h2><div class="notices warning"><p>From this point down, this page is slated to get a revamp</p></div><p>This guide will walk you through how to setup DefectDojo for running in
production using Ubuntu 16.04, nginx, and uwsgi.</p><p><strong>Install, Setup, and Activate Virtualenv</strong></p><p>Assumes running as root or using sudo command for the below.</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>pip install virtualenv

cd /opt

virtualenv dojo

cd /opt/dojo

git clone https://github.com/DefectDojo/django-DefectDojo.git

useradd -m dojo

chown -R dojo /opt/dojo

source ./bin/activate
</code></pre><p><strong>Install Dojo</strong></p><div class="notices warning"><p>The setup.bash installation method will be EOL on 2020-12-31</p></div><pre><code class=language-{.sourceCode data-lang={.sourceCode>cd django-DefectDojo/setup

./setup.bash
</code></pre><p><strong>Install Uwsgi</strong></p><pre><code class=language-{.sourceCode data-lang={.sourceCode>pip install uwsgi
</code></pre><p><strong>Install WKHTML</strong></p><p>from inside the django-DefectDojo/ directory execute:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>./reports.sh
</code></pre><p><strong>Disable Debugging</strong></p><p>Using the text-editor of your choice, change <code>DEBUG</code> in
django-DefectDojo/dojo/settings/settings.py to:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>`DEBUG = False`
</code></pre><p><strong>Configure external database</strong></p><p>If you host your DefectDojo into AWS and you decide to use their managed
database service (AWS RDS), you will have to do the following
configuration updates:</p><ol><li><a href=https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.SSL.html>Download the root
certificate</a>
to encrypt traffic between DefectDojo and the database</li><li>Update your Dockerfile to add the SSL certificate to the container</li></ol><pre><code class=language-{.sourceCode data-lang={.sourceCode>COPY rds-ca-2019-root.pem /etc/ssl/certs/rds-ca-2019-root.pem
</code></pre><ol start=3><li>Update Django settings to use encrypted connection to the database
(Changes highlighted below)</li></ol><pre><code class=language-{.sourceCode data-lang={.sourceCode>DATABASES = {
    'default': env.db('DD_DATABASE_URL')
}
DATABASES['default']['OPTIONS'] = {
'ssl': {'ca': '/etc/ssl/certs/rds-ca-2019-root.pem'}
}
</code></pre><blockquote><dl><dt>else:</dt><dd><dl><dt>DATABASES = {</dt><dd><p>'default': {</p></dd></dl></dd></dl></blockquote><ol start=4><li>Update the environment variables for the database connection:
<em>DD_DATABASE_URL</em> or <em>DD_DATABASE_HOST</em>, <em>DD_DATABASE_PORT</em>,
<em>DD_DATABASE_NAME</em>, <em>DD_DATABASE_USER</em> and
<em>DD_DATABASE_PASSWORD</em>.</li></ol><p>Note: This configuration can be adapted to other cloud providers.</p><p><strong>Start Celery and Beats</strong></p><p>From inside the django-DefectDojo/ directory execute:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>celery -A dojo worker -l info --concurrency 3

celery beat -A dojo -l info
</code></pre><p>It is recommended that you daemonized both these processes with the
sample configurations found
<a href=https://github.com/celery/celery/blob/3.1/extra/supervisord/celeryd.conf>here</a>
and
<a href=https://github.com/celery/celery/blob/3.1/extra/supervisord/celerybeat.conf>here.</a></p><p>However, for a quick setup you can use the following to run both in the
background</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>celery -A dojo worker -l info --concurrency 3 &amp;

celery beat -A dojo -l info &amp;
</code></pre><p><strong>Start Uwsgi</strong></p><p>From inside the django-DefectDojo/ directory execute:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>uwsgi --socket :8001 --wsgi-file wsgi.py --workers 7
</code></pre><p>It is recommended that you use an Upstart job or a @restart cron job to
launch uwsgi on reboot. However, if you&rsquo;re in a hurry you can use the
following to run it in the background:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>uwsgi --socket :8001 --wsgi-file wsgi.py --workers 7 &amp;
</code></pre><p><strong>Making Defect Dojo start on boot</strong></p><p>Below we configure service files for systemd. The commands follow, the
config files are below the Nginx in the next section.</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>$ cd /etc/systemd/system/
$ sudo vi dojo.service
[contents below]

$ sudo systemctl enable dojo
$ sudo systemctl start dojo
$ sudo systemctl status dojo
[ensure it launched OK]

$ sudo vi celery-worker.service
[contents below]

$ sudo systemctl enable celery-worker
$ sudo systemctl start celery-worker
$ sudo systemctl status celery-worker
[ensure it launched OK]

$ sudo vi celery-beat.service
[contents below]

$ sudo systemctl enable celery-beat
$ sudo systemctl start celery-beat
$ sudo systemctl status celery-beat
[ensure it launched OK]
</code></pre><p><em>NGINX Configuration</em></p><p>Everyone feels a little differently about nginx settings, so here are
the barebones to add your to your nginx configuration to proxy uwsgi.
Make sure to modify the filesystem paths if needed:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>upstream django {
  server 127.0.0.1:8001;
}

server {
  listen 80;
  return 301 https://$host$request_uri;
}

server {
  listen 443;
  server_name &lt;YOUR_SERVER_NAME&gt;;

  client_max_body_size 500m; # To accommodate large scan files

  ssl_certificate           &lt;PATH_TO_CRT&gt;;
  ssl_certificate_key       &lt;PATH_TO_KEY&gt;;

  ssl on;

  &lt;YOUR_SSL_SETTINGS&gt; # ciphers, options, logging, etc

  location /static/ {
      alias   &lt;PATH_TO_DOJO&gt;/django-DefectDojo/static/;
  }

  location /media/ {
      alias   &lt;PATH_TO_DOJO&gt;/django-DefectDojo/media/;
  }

  location / {
      uwsgi_pass django;
      include     &lt;PATH_TO_DOJO&gt;/django-DefectDojo/wsgi_params;
  }
}
</code></pre><p><em>Systemd Configuration Files</em></p><p>dojo.service</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>[Unit]
Description=uWSGI instance to serve DefectDojo
Requires=nginx.service mysql.service
Before=nginx.service
After=mysql.service

[Service]
ExecStart=/bin/bash -c 'su - dojo -c &quot;cd /opt/dojo/django-DefectDojo &amp;&amp; source ../bin/activate &amp;&amp; uwsgi --socket :8001 --wsgi-file wsgi.py --workers 7&quot;'
Restart=always
RestartSec=3
#StandardOutput=syslog
#StandardError=syslog
SyslogIdentifier=dojo

[Install]
WantedBy=multi-user.target
</code></pre><p>celery-worker.service</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>[Unit]
Description=celery workers for DefectDojo
Requires=dojo.service
After=dojo.service

[Service]
ExecStart=/bin/bash -c 'su - dojo -c &quot;cd /opt/dojo/django-DefectDojo &amp;&amp; source ../bin/activate &amp;&amp; celery -A dojo worker -l info --concurrency 3&quot;'
Restart=always
RestartSec=3
#StandardOutput=syslog
#StandardError=syslog
SyslogIdentifier=celeryworker

[Install]
WantedBy=multi-user.target
</code></pre><p>celery-beat.service</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>[Unit]
Description=celery beat for DefectDojo
Requires=dojo.service
After=dojo.service

[Service]
ExecStart=/bin/bash -c 'su - dojo -c &quot;cd /opt/dojo/django-DefectDojo &amp;&amp; source ../bin/activate &amp;&amp; celery beat -A dojo -l info&quot;'
Restart=always
RestartSec=3
#StandardOutput=syslog
#StandardError=syslog
SyslogIdentifier=celerybeat

[Install]
WantedBy=multi-user.target
</code></pre><p><em>That's it!</em></p><p><em>Monitoring</em></p><p>To expose Django statistics for Prometheus, using the text-editor of
your choice, change <code>DJANGO_METRICS_ENABLED</code> to True in
django-DefectDojo/dojo/settings/settings.py to:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>`DJANGO_METRICS_ENABLED = True`
</code></pre><p>Or export <code>DD_DJANGO_METRICS_ENABLED</code> with the same value.</p><p>Prometheus endpoint than is available under the path:
<code>http://dd_server/django_metrics/metrics</code></p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/django-DefectDojo/js/clipboard.min.js?1619336002></script><script src=/django-DefectDojo/js/perfect-scrollbar.min.js?1619336002></script><script src=/django-DefectDojo/js/perfect-scrollbar.jquery.min.js?1619336002></script><script src=/django-DefectDojo/js/jquery.sticky.js?1619336002></script><script src=/django-DefectDojo/js/featherlight.min.js?1619336002></script><script src=/django-DefectDojo/js/highlight.pack.js?1619336002></script><script>hljs.initHighlightingOnLoad();</script><script src=/django-DefectDojo/js/modernizr.custom-3.6.0.js?1619336002></script><script src=/django-DefectDojo/js/learn.js?1619336002></script><script src=/django-DefectDojo/js/hugo-learn.js?1619336002></script><script src=/django-DefectDojo/mermaid/mermaid.js?1619336002></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>